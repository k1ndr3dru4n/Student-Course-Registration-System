@using Microsoft.AspNetCore.Localization
@using Microsoft.Extensions.Localization
@using System.Globalization
@using Microsoft.JSInterop
@inject IStringLocalizer<SMS.Resources.SharedResources> Localizer
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<div class="modern-language-selector">
    <div class="language-dropdown" tabindex="0">
        <div class="selected-language">
            <span class="flag-icon">@GetCurrentFlag()</span>
            <span class="language-text">@GetCurrentLanguageText()</span>
            <span class="dropdown-arrow">â–¾</span>
        </div>
        <div class="language-options">
            <div class="language-option @(currentCulture == "zh-CN" ? "active" : "")" @onclick="@(() => SwitchLanguage("zh-CN"))">
                <span class="flag-icon">ğŸ‡¨ğŸ‡³</span>
                <span class="language-text">ä¸­æ–‡</span>
            </div>
            <div class="language-option @(currentCulture == "en-US" ? "active" : "")" @onclick="@(() => SwitchLanguage("en-US"))">
                <span class="flag-icon">ğŸ‡ºğŸ‡¸</span>
                <span class="language-text">English</span>
            </div>
        </div>
    </div>
</div>

@code {
    private string currentCulture = "zh-CN";

    protected override void OnInitialized()
    {
        // ä»URLä¸­è·å–cultureå‚æ•°ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰UIæ–‡åŒ–
        var uri = new Uri(Navigation.Uri);
        var query = uri.Query;
        
        if (query.Contains("culture="))
        {
            var match = System.Text.RegularExpressions.Regex.Match(query, @"culture=([^&]*)");
            if (match.Success)
            {
                currentCulture = match.Groups[1].Value;
            }
        }
        else
        {
            currentCulture = CultureInfo.CurrentUICulture.Name;
        }
    }

    protected override void OnParametersSet()
    {
        // æ¯æ¬¡å‚æ•°è®¾ç½®æ—¶é‡æ–°æ£€æŸ¥URLä¸­çš„cultureå‚æ•°
        var uri = new Uri(Navigation.Uri);
        var query = uri.Query;
        
        if (query.Contains("culture="))
        {
            var match = System.Text.RegularExpressions.Regex.Match(query, @"culture=([^&]*)");
            if (match.Success)
            {
                var urlCulture = match.Groups[1].Value;
                if (urlCulture != currentCulture)
                {
                    currentCulture = urlCulture;
                    StateHasChanged();
                }
            }
        }
    }

    private string GetCurrentFlag()
    {
        return currentCulture switch
        {
            "zh-CN" => "ğŸ‡¨ğŸ‡³",
            "en-US" => "ğŸ‡ºğŸ‡¸",
            _ => "ğŸŒ"
        };
    }

    private string GetCurrentLanguageText()
    {
        return currentCulture switch
        {
            "zh-CN" => "ä¸­æ–‡",
            "en-US" => "English",
            _ => "Language"
        };
    }

    private void SwitchLanguage(string culture)
    {
        if (culture != currentCulture)
        {
            // è·å–å½“å‰é¡µé¢çš„è·¯å¾„
            var currentPath = new Uri(Navigation.Uri).AbsolutePath;
            
            // é‡å®šå‘åˆ°è®¾ç½®æ–‡åŒ–é¡µé¢ï¼Œç„¶åè¿”å›å½“å‰é¡µé¢
            var setCultureUrl = $"/set-culture?culture={culture}&returnUrl={Uri.EscapeDataString(currentPath)}";
            Navigation.NavigateTo(setCultureUrl, forceLoad: true);
        }
    }
}

<style>
    .modern-language-selector {
        position: relative;
        display: inline-flex;
        align-items: center;
        height: 100%;
    }

    .language-dropdown {
        position: relative;
        cursor: pointer;
        outline: none;
        display: flex;
        align-items: center;
        height: 100%;
    }

    .language-dropdown:hover .language-options,
    .language-dropdown:focus .language-options,
    .language-dropdown:focus-within .language-options {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .selected-language {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        backdrop-filter: blur(8px);
        user-select: none;
        min-width: 100px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        height: 40px; /* ä¸Headeré«˜åº¦åŒ¹é… */
        margin-bottom: 0;
    }

    .selected-language:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .flag-icon {
        font-size: 16px;
        line-height: 1;
    }

    .language-text {
        flex-grow: 1;
        text-align: left;
    }

    .dropdown-arrow {
        font-size: 12px;
        transition: transform 0.2s ease;
        color: rgba(255, 255, 255, 0.7);
    }

    .language-dropdown:hover .dropdown-arrow,
    .language-dropdown:focus .dropdown-arrow {
        transform: rotate(180deg);
        color: rgba(255, 255, 255, 0.9);
    }

    .language-options {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px);
        transition: all 0.2s ease;
        margin-top: 4px;
    }

    .language-option {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        color: #333;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .language-option:last-child {
        border-bottom: none;
    }

    .language-option:hover {
        background: rgba(24, 144, 255, 0.1);
        color: #1890ff;
        transform: translateX(4px);
    }

    .language-option.active {
        background: linear-gradient(135deg, #1890ff, #40a9ff);
        color: white;
        font-weight: 600;
    }

    .language-option.active:hover {
        background: linear-gradient(135deg, #096dd9, #1890ff);
        transform: translateX(0);
    }

    /* å“åº”å¼è®¾è®¡ */
    @@media (max-width: 768px) {
        .selected-language {
            min-width: 80px;
            padding: 6px 10px;
            font-size: 13px;
        }

        .language-option {
            padding: 10px 14px;
            font-size: 13px;
        }

        .language-text {
            display: none;
        }
    }

    /* æ”¹å–„é”®ç›˜å¯¼èˆªçš„å¯è®¿é—®æ€§ */
    .language-dropdown:focus {
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
    }

    .language-option:focus {
        outline: 2px solid #1890ff;
        outline-offset: -2px;
    }
</style>
