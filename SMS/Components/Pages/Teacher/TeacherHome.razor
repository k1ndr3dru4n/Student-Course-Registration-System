@page "/teacher-home"
@using SMS.Models
@using Microsoft.EntityFrameworkCore
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject IDbContextFactory<SMS.CimContext> DbFactory
@rendermode InteractiveServer

<PageTitle>主页 - 教师端</PageTitle>

@if (isLoading)
{
    <div style="display: flex; justify-content: center; align-items: center; height: 400px;">
        <AntDesign.Spin Size="@AntDesign.SpinSize.Large" />
        <span style="margin-left: 16px; color: #666;">正在加载数据...</span>
    </div>
}
else if (!isAuthenticated)
{
    <div style="display: flex; justify-content: center; align-items: center; height: 400px;">
        <div style="text-align: center;">
            <AntDesign.Alert Type="@AntDesign.AlertType.Error" 
                           Message="认证失败" 
                           Description="您没有权限访问此页面或登录已过期，正在跳转到登录页面..." 
                           ShowIcon="true" />
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(lastExceptionMessage))
{
    <div style="display: flex; justify-content: center; align-items: center; height: 400px;">
        <div style="text-align: center;">
            <AntDesign.Alert Type="@AntDesign.AlertType.Error" 
                           Message="加载数据时出现错误" 
                           Description="@lastExceptionMessage" 
                           ShowIcon="true" />
        </div>
    </div>
}
else if (isAuthenticated)
{
    <!-- 欢迎横幅 -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 32px; border-radius: 16px; margin-bottom: 32px; color: white;">
        <h1 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 600; color: white;">欢迎回来，@currentUser！</h1>
    </div>

    <!-- 数据统计面板 -->
    <div style="margin-bottom: 32px;">
        <div class="intro-container" style="margin-bottom: 24px;">
            <AntDesign.Typography>
                <AntDesign.Title Level="4">欢迎使用教师管理系统！</AntDesign.Title>
                <AntDesign.Paragraph>
                    本系统集成了教师、课程、学生、成绩等多项管理功能，支持信息检索、成绩录入、课程管理等操作。教师可通过左侧导航栏快速访问各类管理页面，实现高效的教学管理与信息查询。
                </AntDesign.Paragraph>
            </AntDesign.Typography>
        </div>
        <h2 style="margin-bottom: 24px; color: #1f2937; font-weight: 600; font-size: 20px;">
            <AntDesign.Icon Type="dashboard" style="margin-right: 8px; color: #1890ff;" />
            教师数据概览
        </h2>
        <AntDesign.Row Gutter="24">
            <!-- 我的课程统计 -->
            <AntDesign.Col Xs="24" Sm="12" Md="6">
                <AntDesign.Card style="border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: none;">
                    <Body>
                        <div style="padding: 24px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">我的课程数</div>
                                    <div style="font-size: 32px; font-weight: 700; color: #1f2937;">@courseCount</div>
                                </div>
                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <AntDesign.Icon Type="book" style="font-size: 24px; color: white;" />
                                </div>
                            </div>
                        </div>
                    </Body>
                </AntDesign.Card>
            </AntDesign.Col>
            <!-- 我的学生统计 -->
            <AntDesign.Col Xs="24" Sm="12" Md="6">
                <AntDesign.Card style="border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: none;">
                    <Body>
                        <div style="padding: 24px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">我的学生数</div>
                                    <div style="font-size: 32px; font-weight: 700; color: #1f2937;">@studentCount</div>
                                </div>
                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <AntDesign.Icon Type="idcard" style="font-size: 24px; color: white;" />
                                </div>
                            </div>
                        </div>
                    </Body>
                </AntDesign.Card>
            </AntDesign.Col>
            <!-- 成绩管理统计 -->
            <AntDesign.Col Xs="24" Sm="12" Md="6">
                <AntDesign.Card style="border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: none;">
                    <Body>
                        <div style="padding: 24px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">成绩管理</div>
                                    <div style="font-size: 32px; font-weight: 700; color: #1f2937;">@gradeCount</div>
                                </div>
                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <AntDesign.Icon Type="solution" style="font-size: 24px; color: white;" />
                                </div>
                            </div>
                        </div>
                    </Body>
                </AntDesign.Card>
            </AntDesign.Col>
            <!-- 选课管理统计 -->
            <AntDesign.Col Xs="24" Sm="12" Md="6">
                <AntDesign.Card style="border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: none;">
                    <Body>
                        <div style="padding: 24px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">选课管理</div>
                                    <div style="font-size: 32px; font-weight: 700; color: #1f2937;">@enrollmentCount</div>
                                </div>
                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <AntDesign.Icon Type="team" style="font-size: 24px; color: white;" />
                                </div>
                            </div>
                        </div>
                    </Body>
                </AntDesign.Card>
            </AntDesign.Col>
        </AntDesign.Row>
    </div>
}

@code {
    private string lastExceptionMessage = "";
    private string lastExceptionStack = "";
    private bool isLoading = true;
    private bool isAuthenticated = false;
    private string currentUser = string.Empty;
    private CimContext? DB;
    // 统计数据
    private int studentCount = 0;
    private int courseCount = 0;
    private int gradeCount = 0;
    private int enrollmentCount = 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            DB = DbFactory.CreateDbContext();
            await CheckAuthentication();
            if (isAuthenticated)
            {
                await LoadStatistics();
            }
            StateHasChanged();
        }
    }

    private async Task CheckAuthentication()
    {
        try
        {
            currentUser = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "currentUser") ?? string.Empty;
            var userRole = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userRole") ?? string.Empty;
            
            if (string.IsNullOrEmpty(currentUser))
            {
                NavigationManager.NavigateTo("/login", forceLoad: true);
                return;
            }
            
            // 检查用户角色是否为教师
            if (userRole != "1") // 1 表示教师角色
            {
                // 如果不是教师角色，重定向到登录页面
                NavigationManager.NavigateTo("/login", forceLoad: true);
                return;
            }
            
            isAuthenticated = true;
        }
        catch (Exception ex)
        {
            // 记录异常信息
            lastExceptionMessage = ex.Message;
            lastExceptionStack = ex.StackTrace ?? "";
            NavigationManager.NavigateTo("/login", forceLoad: true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadStatistics()
    {
        try
        {
            if (DB == null)
            {
                lastExceptionMessage = "数据库上下文未初始化";
                lastExceptionStack = "";
                return;
            }
            
            // 先通过用户名查找User记录，然后通过TeacherId关联到Teacher表
            var user = await DB.SMS_Users.FirstOrDefaultAsync(u => u.Username == currentUser);
            if (user == null)
            {
                lastExceptionMessage = "未找到对应的用户信息";
                lastExceptionStack = "";
                return;
            }
            
            if (user.TeacherId == null)
            {
                lastExceptionMessage = "当前用户未关联教师信息";
                lastExceptionStack = "";
                return;
            }
            
            var teacher = await DB.SMS_Teachers.FirstOrDefaultAsync(t => t.Id == user.TeacherId);
            if (teacher == null)
            {
                lastExceptionMessage = "未找到对应的教师信息";
                lastExceptionStack = "";
                return;
            }
            
            // 统计教师所教课程数
            courseCount = await DB.SMS_Courses.CountAsync(c => c.TeacherId == teacher.TID);
            
            // 统计教师所教学生数
            var teacherCourseIds = await DB.SMS_Courses
                .Where(c => c.TeacherId == teacher.TID)
                .Select(c => c.CID)
                .ToListAsync();
            
            studentCount = await DB.SMS_Enrollments
                .Where(e => teacherCourseIds.Contains(e.CourseCID))
                .Select(e => e.StudentSID)
                .Distinct()
                .CountAsync();
            
            // 统计教师成绩管理条数
            gradeCount = await DB.SMS_Enrollments
                .Where(e => teacherCourseIds.Contains(e.CourseCID) && e.Grade.HasValue)
                .CountAsync();
            
            // 统计教师选课管理条数
            enrollmentCount = await DB.SMS_Enrollments
                .Where(e => teacherCourseIds.Contains(e.CourseCID))
                .CountAsync();
            
            lastExceptionMessage = "";
            lastExceptionStack = "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            studentCount = 0;
            courseCount = 0;
            gradeCount = 0;
            enrollmentCount = 0;
            lastExceptionMessage = ex.Message;
            lastExceptionStack = ex.StackTrace ?? "";
        }
    }
}
