@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@page "/courses"
@using Microsoft.AspNetCore.Components.QuickGrid
@using AntDesign

@using Microsoft.AspNetCore.Components
@inject SMS.CimContext DB
@inject IJSRuntime JS
@using SMS.Models
@rendermode InteractiveServer
@inject NavigationManager Navigation

<PageTitle>课程管理</PageTitle>

<div style="padding: 24px;">
    <!-- 面包屑导航 -->
    <AntDesign.Breadcrumb style="margin-bottom: 24px;">
        <BreadcrumbItem>
            <a href="/directory">目录</a>
        </BreadcrumbItem>
        <BreadcrumbItem>课程管理</BreadcrumbItem>
    </AntDesign.Breadcrumb>

    <Card Title="课程管理" Style="margin: 0;">
    <Extra>
        <Space>
            <SpaceItem>
                <Search Placeholder="搜索任意内容" WrapperStyle="width: 250px;" ClassicSearchIcon 
                        @bind-Value="searchText" OnSearch="OnSearch" />
            </SpaceItem>
            <SpaceItem>
                <a href="courses/create" style="text-decoration: none;">
                    <Button Type="@ButtonType.Primary">
                        <Icon Type="plus" Theme="@IconThemeType.Outline" />
                        新增课程
                    </Button>
                </a>
            </SpaceItem>
        </Space>
    </Extra>
    <Body>
    <QuickGrid Class="table quickgrid-table" Items="FilteredCourses">
            <Microsoft.AspNetCore.Components.QuickGrid.PropertyColumn Property="course => course.CID" Title="课程编号">
                <HeaderTemplate>
                    <div style="display: flex; align-items: center;">
                        <span>课程编号</span>
                        <span class="quickgrid-sort-icons" style="margin-left: 8px; flex-direction: column;">
                            <span class="quickgrid-sort-arrow @(sortField=="CID"&&sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("CID", true)'>▲</span>
                            <span class="quickgrid-sort-arrow @(sortField=="CID"&&!sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("CID", false)'>▼</span>
                        </span>
                    </div>
                </HeaderTemplate>
            </Microsoft.AspNetCore.Components.QuickGrid.PropertyColumn>
            <Microsoft.AspNetCore.Components.QuickGrid.PropertyColumn Property="course => course.Name" Title="课程名称">
                <HeaderTemplate>
                    <div style="display: flex; align-items: center;">
                        <span>课程名称</span>
                        <span class="quickgrid-sort-icons" style="margin-left: 8px; flex-direction: column;">
                            <span class="quickgrid-sort-arrow @(sortField=="Name"&&sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("Name", true)'>▲</span>
                            <span class="quickgrid-sort-arrow @(sortField=="Name"&&!sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("Name", false)'>▼</span>
                        </span>
                    </div>
                </HeaderTemplate>
            </Microsoft.AspNetCore.Components.QuickGrid.PropertyColumn>
            <Microsoft.AspNetCore.Components.QuickGrid.PropertyColumn Property="course => course.Credits" Title="学分">
                <HeaderTemplate>
                    <div style="display: flex; align-items: center;">
                        <span>学分</span>
                        <span class="quickgrid-sort-icons" style="margin-left: 8px; flex-direction: column;">
                            <span class="quickgrid-sort-arrow @(sortField=="Credits"&&sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("Credits", true)'>▲</span>
                            <span class="quickgrid-sort-arrow @(sortField=="Credits"&&!sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("Credits", false)'>▼</span>
                        </span>
                    </div>
                </HeaderTemplate>
            </Microsoft.AspNetCore.Components.QuickGrid.PropertyColumn>
            <TemplateColumn Context="course" Title="授课教师">
                <HeaderTemplate>
                    <div style="display: flex; align-items: center;">
                        <span>授课教师</span>
                        <span class="quickgrid-sort-icons" style="margin-left: 8px; flex-direction: column;">
                            <span class="quickgrid-sort-arrow @(sortField=="Teacher"&&sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("Teacher", true)'>▲</span>
                            <span class="quickgrid-sort-arrow @(sortField=="Teacher"&&!sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("Teacher", false)'>▼</span>
                        </span>
                    </div>
                </HeaderTemplate>
                <ChildContent>
                    @if (course.Teacher != null)
                    {
                        <span>@course.Teacher.Name (工号: @course.Teacher.TID)</span>
                    }
                    else
                    {
                        <span style="color: #999;">未分配</span>
                    }
                </ChildContent>
            </TemplateColumn>
            <TemplateColumn Context="course" Title="课程状态">
                <HeaderTemplate>
                    <div style="display: flex; align-items: center;">
                        <span>课程状态</span>
                        <span class="quickgrid-sort-icons" style="margin-left: 8px; flex-direction: column;">
                            <span class="quickgrid-sort-arrow @(sortField=="CourseStatus"&&sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("CourseStatus", true)'>▲</span>
                            <span class="quickgrid-sort-arrow @(sortField=="CourseStatus"&&!sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("CourseStatus", false)'>▼</span>
                        </span>
                    </div>
                </HeaderTemplate>
                <ChildContent>
                    @if (course.CourseStatus == CourseStatus.未开课)
                    {
                        <span style="color: #faad14; background: #fffbe6; padding: 4px 10px; border-radius: 4px;">未开课</span>
                    }
                    else if (course.CourseStatus == CourseStatus.正在进行)
                    {
                        <span style="color: #52c41a; background: #f6ffed; padding: 4px 10px; border-radius: 4px;">正在进行</span>
                    }
                    else if (course.CourseStatus == CourseStatus.已结束)
                    {
                        <span style="color: #8c8c8c; background: #f5f5f5; padding: 4px 10px; border-radius: 4px;">已结束</span>
                    }
                </ChildContent>
            </TemplateColumn>

            <TemplateColumn Context="course" Title="操作">
                <Space>
                    <SpaceItem>
                        <a href="@($"courses/edit?id={course.Id}")" style="text-decoration: none;">
                            <Button Type="@ButtonType.Link">
                                <Icon Type="edit" Theme="@IconThemeType.Outline" />
                                编辑
                            </Button>
                        </a>
                    </SpaceItem>
                    <SpaceItem>
                        <a href="@($"courses/details/{course.Id}")" style="text-decoration: none;">
                            <Button Type="@ButtonType.Link">
                                <Icon Type="eye" Theme="@IconThemeType.Outline" />
                                详情
                            </Button>
                        </a>
                    </SpaceItem>
                    <SpaceItem>
                        <a href="@($"courses/delete?id={course.Id}")" style="text-decoration: none;">
                            <Button Type="@ButtonType.Link" Danger>
                                <Icon Type="delete" Theme="@IconThemeType.Outline" />
                                删除
                            </Button>
                        </a>
                    </SpaceItem>
                </Space>
            </TemplateColumn>
        </QuickGrid>
    </Body>
</Card>

@code {
    private string searchText = string.Empty;
    private List<Course> courses = new List<Course>();
    private List<Course> filteredCourses = new List<Course>();
    private string sortField = "CID";
    private bool sortAsc = true;
    private void SortBy(string field, bool asc)
    {
        sortField = field;
        sortAsc = asc;
        switch (field)
        {
            case "CID":
                filteredCourses = asc ? filteredCourses.OrderBy(c => c.CID).ToList() : filteredCourses.OrderByDescending(c => c.CID).ToList();
                break;
            case "Name":
                filteredCourses = asc ? filteredCourses.OrderBy(c => c.Name).ToList() : filteredCourses.OrderByDescending(c => c.Name).ToList();
                break;
            case "Credits":
                filteredCourses = asc ? filteredCourses.OrderBy(c => c.Credits).ToList() : filteredCourses.OrderByDescending(c => c.Credits).ToList();
                break;
            case "Teacher":
                filteredCourses = asc ? filteredCourses.OrderBy(c => c.Teacher != null ? c.Teacher.Name : "")
                    .ToList() : filteredCourses.OrderByDescending(c => c.Teacher != null ? c.Teacher.Name : "")
                    .ToList();
                break;
            case "CourseStatus":
                filteredCourses = asc ? filteredCourses.OrderBy(c => c.CourseStatus).ToList() : filteredCourses.OrderByDescending(c => c.CourseStatus).ToList();
                break;
        }
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            courses = await DB.SMS_Courses.Include(c => c.Teacher).OrderBy(c => c.Name).ToListAsync();
            filteredCourses = courses.ToList();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"加载数据失败: {ex.Message}");
        }
    }

    private IQueryable<Course> FilteredCourses
    {
        get
        {
            return filteredCourses.AsQueryable();
        }
    }

    private void OnSearch(string value)
    {
        searchText = value;
        FilterCourses();
    }

    private void FilterCourses()
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            filteredCourses = courses.ToList();
        }
        else
        {
            filteredCourses = courses.Where(c => 
                (c.Name != null && c.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase)) || 
                c.CID.ToString().Contains(searchText) ||
                c.Credits.ToString().Contains(searchText) ||
                (c.Description != null && c.Description.Contains(searchText, StringComparison.OrdinalIgnoreCase)) ||
                c.CourseStatus.ToString().Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                (c.Teacher != null && c.Teacher.Name != null && c.Teacher.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase)) ||
                (c.Teacher != null && c.Teacher.TID.ToString().Contains(searchText)) ||
                (c.Teacher != null && c.Teacher.Major != null && c.Teacher.Major.Contains(searchText, StringComparison.OrdinalIgnoreCase)) ||
                (c.Teacher != null && c.Teacher.Email != null && c.Teacher.Email.Contains(searchText, StringComparison.OrdinalIgnoreCase)) ||
                (c.CreateUser != null && c.CreateUser.Contains(searchText, StringComparison.OrdinalIgnoreCase)) ||
                (c.UpdateUser != null && c.UpdateUser.Contains(searchText, StringComparison.OrdinalIgnoreCase)) ||
                c.CreateDate.ToString().Contains(searchText) ||
                c.UpdateDate.ToString().Contains(searchText)).ToList();
        }
        StateHasChanged();
    }
}
</div>
