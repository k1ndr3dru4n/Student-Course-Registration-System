@page "/admin-teachers"
@using Microsoft.AspNetCore.Components.QuickGrid
@using Microsoft.EntityFrameworkCore
@using AntDesign
@using Microsoft.AspNetCore.Components
@inject SMS.CimContext DB
@inject NavigationManager NavigationManager
@using SMS.Models
@rendermode InteractiveServer

<PageTitle>教师管理</PageTitle>

<div style="margin: 20px;">
    <Breadcrumb Style="margin-bottom: 20px;">
        <BreadcrumbItem>
            <a href="/admin-directory" style="color: #1890ff; text-decoration: none;">目录</a>
        </BreadcrumbItem>
        <BreadcrumbItem>教师管理</BreadcrumbItem>
    </Breadcrumb>

    <Card Title="教师管理">
    <Extra>
        <Space>
            <SpaceItem>
                <Search Placeholder="搜索任意内容" WrapperStyle="width: 250px;" ClassicSearchIcon 
                        @bind-Value="searchText" OnSearch="OnSearch" />
            </SpaceItem>
            <SpaceItem>
                <a href="/admin-teachers/create" style="text-decoration: none;">
                    <Button Type="@ButtonType.Primary">
                        <Icon Type="plus" Theme="@IconThemeType.Outline" />
                        新增教师
                    </Button>
                </a>
            </SpaceItem>
        </Space>
    </Extra>
    <Body>
    <QuickGrid Class="table quickgrid-table" Items="FilteredTeachers">
            <Microsoft.AspNetCore.Components.QuickGrid.PropertyColumn Property="teacher => teacher.TID" Title="工号">
                <HeaderTemplate>
                    <div style="display: flex; align-items: center;">
                        <span>工号</span>
                        <span class="quickgrid-sort-icons" style="margin-left: 8px; flex-direction: column;">
                            <span class="quickgrid-sort-arrow @(sortField=="TID"&&sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("TID", true)'>▲</span>
                            <span class="quickgrid-sort-arrow @(sortField=="TID"&&!sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("TID", false)'>▼</span>
                        </span>
                    </div>
                </HeaderTemplate>
            </Microsoft.AspNetCore.Components.QuickGrid.PropertyColumn>
            <Microsoft.AspNetCore.Components.QuickGrid.PropertyColumn Property="teacher => teacher.Name" Title="姓名">
                <HeaderTemplate>
                    <div style="display: flex; align-items: center;">
                        <span>姓名</span>
                        <span class="quickgrid-sort-icons" style="margin-left: 8px; flex-direction: column;">
                            <span class="quickgrid-sort-arrow @(sortField=="Name"&&sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("Name", true)'>▲</span>
                            <span class="quickgrid-sort-arrow @(sortField=="Name"&&!sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("Name", false)'>▼</span>
                        </span>
                    </div>
                </HeaderTemplate>
            </Microsoft.AspNetCore.Components.QuickGrid.PropertyColumn>
            <Microsoft.AspNetCore.Components.QuickGrid.PropertyColumn Property="teacher => teacher.Age" Title="年龄">
                <HeaderTemplate>
                    <div style="display: flex; align-items: center;">
                        <span>年龄</span>
                        <span class="quickgrid-sort-icons" style="margin-left: 8px; flex-direction: column;">
                            <span class="quickgrid-sort-arrow @(sortField=="Age"&&sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("Age", true)'>▲</span>
                            <span class="quickgrid-sort-arrow @(sortField=="Age"&&!sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("Age", false)'>▼</span>
                        </span>
                    </div>
                </HeaderTemplate>
            </Microsoft.AspNetCore.Components.QuickGrid.PropertyColumn>
            <Microsoft.AspNetCore.Components.QuickGrid.PropertyColumn Property="teacher => teacher.Major" Title="专业">
                <HeaderTemplate>
                    <div style="display: flex; align-items: center;">
                        <span>专业</span>
                        <span class="quickgrid-sort-icons" style="margin-left: 8px; flex-direction: column;">
                            <span class="quickgrid-sort-arrow @(sortField=="Major"&&sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("Major", true)'>▲</span>
                            <span class="quickgrid-sort-arrow @(sortField=="Major"&&!sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("Major", false)'>▼</span>
                        </span>
                    </div>
                </HeaderTemplate>
            </Microsoft.AspNetCore.Components.QuickGrid.PropertyColumn>
            <Microsoft.AspNetCore.Components.QuickGrid.PropertyColumn Property="teacher => teacher.Email" Title="邮箱">
                <HeaderTemplate>
                    <div style="display: flex; align-items: center;">
                        <span>邮箱</span>
                        <span class="quickgrid-sort-icons" style="margin-left: 8px; flex-direction: column;">
                            <span class="quickgrid-sort-arrow @(sortField=="Email"&&sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("Email", true)'>▲</span>
                            <span class="quickgrid-sort-arrow @(sortField=="Email"&&!sortAsc?"active":"inactive")" style="cursor:pointer;" @onclick='() => SortBy("Email", false)'>▼</span>
                        </span>
                    </div>
                </HeaderTemplate>
            </Microsoft.AspNetCore.Components.QuickGrid.PropertyColumn>

            <TemplateColumn Context="teacher" Title="操作">
                <Space>
                    <SpaceItem>
                        <a href="@($"/admin-teachers/edit?id={teacher.Id}")" style="text-decoration: none;">
                            <Button Type="@ButtonType.Link">
                                <Icon Type="edit" Theme="@IconThemeType.Outline" />
                                编辑
                            </Button>
                        </a>
                    </SpaceItem>
                    <SpaceItem>
                        <a href="@($"/admin-teachers/details/{teacher.Id}")" style="text-decoration: none;">
                            <Button Type="@ButtonType.Link">
                                <Icon Type="eye" Theme="@IconThemeType.Outline" />
                                详情
                            </Button>
                        </a>
                    </SpaceItem>
                    <SpaceItem>
                        <a href="@($"/admin-teachers/delete?id={teacher.Id}")" style="text-decoration: none;">
                            <Button Type="@ButtonType.Link" Danger>
                                <Icon Type="delete" Theme="@IconThemeType.Outline" />
                                删除
                            </Button>
                        </a>
                    </SpaceItem>
                </Space>
            </TemplateColumn>
        </QuickGrid>
    </Body>
</Card>
</div>

@code {
    private string searchText = string.Empty;
    private List<Teacher> teachers = new List<Teacher>();
    private List<Teacher> filteredTeachers = new List<Teacher>();
    private string sortField = "TID";
    private bool sortAsc = true;
    private void SortBy(string field, bool asc)
    {
        sortField = field;
        sortAsc = asc;
        switch (field)
        {
            case "TID":
                filteredTeachers = asc ? filteredTeachers.OrderBy(t => t.TID).ToList() : filteredTeachers.OrderByDescending(t => t.TID).ToList();
                break;
            case "Name":
                filteredTeachers = asc ? filteredTeachers.OrderBy(t => t.Name).ToList() : filteredTeachers.OrderByDescending(t => t.Name).ToList();
                break;
            case "Age":
                filteredTeachers = asc ? filteredTeachers.OrderBy(t => t.Age).ToList() : filteredTeachers.OrderByDescending(t => t.Age).ToList();
                break;
            case "Major":
                filteredTeachers = asc ? filteredTeachers.OrderBy(t => t.Major).ToList() : filteredTeachers.OrderByDescending(t => t.Major).ToList();
                break;
            case "Email":
                filteredTeachers = asc ? filteredTeachers.OrderBy(t => t.Email).ToList() : filteredTeachers.OrderByDescending(t => t.Email).ToList();
                break;
        }
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            teachers = await DB.SMS_Teachers.OrderBy(t => t.Name).ToListAsync();
            filteredTeachers = teachers.ToList();
        }
        catch (Exception)
        {
            // 可以在这里记录错误或显示错误信息
        }
    }

    private IQueryable<Teacher> FilteredTeachers
    {
        get
        {
            return filteredTeachers.AsQueryable();
        }
    }

    private void OnSearch(string value)
    {
        searchText = value;
        FilterTeachers();
    }

    private void FilterTeachers()
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            filteredTeachers = teachers.ToList();
        }
        else
        {
            filteredTeachers = teachers.Where(t => 
                t.TID.ToString().Contains(searchText) ||
                (t.Name != null && t.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase)) || 
                t.Age.ToString().Contains(searchText) ||
                (t.Major != null && t.Major.Contains(searchText, StringComparison.OrdinalIgnoreCase)) ||
                (t.Email != null && t.Email.Contains(searchText, StringComparison.OrdinalIgnoreCase)) ||
                (t.CreateUser != null && t.CreateUser.Contains(searchText, StringComparison.OrdinalIgnoreCase)) ||
                (t.UpdateUser != null && t.UpdateUser.Contains(searchText, StringComparison.OrdinalIgnoreCase)) ||
                t.CreateDate.ToString().Contains(searchText) ||
                t.UpdateDate.ToString().Contains(searchText)).ToList();
        }
        StateHasChanged();
    }
}
