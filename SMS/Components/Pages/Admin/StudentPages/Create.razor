@page "/admin-students/create"
@inject SMS.CimContext DB
@using SMS.Models
@using Microsoft.EntityFrameworkCore
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Create</PageTitle>

<h1>Create</h1>

<h4>创建学生</h4>
<AntDesign.Divider />
<AntDesign.Row>
    <AntDesign.Col Span="12">
        <AntDesign.Card Title="新建学生信息">
            <EditForm Model="@Student" OnValidSubmit="AddStudent">
                <DataAnnotationsValidator />
                <ValidationSummary style="color: #ff4d4f;" />
                <div style="margin-bottom: 16px;">
                    <label>学号:</label>
                    <AntDesign.Input Value="@generatedSID" Disabled="true" Placeholder="系统将自动生成学号" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px; background-color: #f5f5f5;" />
                </div>
                <div style="margin-bottom: 16px;">
                    <label>姓名:</label>
                    <InputText @bind-Value="Student.Name" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px;" />
                    <ValidationMessage For="() => Student.Name" style="color: #ff4d4f;" />
                </div>
                <div style="margin-bottom: 16px;">
                    <label>年龄:</label>
                    <Microsoft.AspNetCore.Components.Forms.InputNumber @bind-Value="Student.Age" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px;" />
                    <ValidationMessage For="() => Student.Age" style="color: #ff4d4f;" />
                </div>
                <div style="margin-bottom: 16px;">
                    <label>专业:</label>
                    <InputText @bind-Value="Student.Major" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px;" />
                    <ValidationMessage For="() => Student.Major" style="color: #ff4d4f;" />
                </div>
                <div style="margin-bottom: 16px;">
                    <label>邮箱:</label>
                    <InputText @bind-Value="Student.Email" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 6px;" />
                    <ValidationMessage For="() => Student.Email" style="color: #ff4d4f;" />
                </div>
                <div style="margin-bottom: 16px; display: flex; gap: 8px;">
                    <AntDesign.Button Type="@AntDesign.ButtonType.Primary" HtmlType="submit" Loading="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span>创建中...</span>
                        }
                        else
                        {
                            <span>创建</span>
                        }
                    </AntDesign.Button>
                    <AntDesign.Button style="margin-left: 8px;" OnClick="@(() => NavigationManager.NavigateTo("/admin-students"))">取消</AntDesign.Button>
                </div>
            </EditForm>
        </AntDesign.Card>
    </AntDesign.Col>
</AntDesign.Row>

<div style="margin-top: 16px;">
                <AntDesign.Button OnClick="@(() => NavigationManager.NavigateTo("/admin-students"))">返回列表</AntDesign.Button>
</div>

@code {

    [Inject]
    public IJSRuntime JSRuntime { get; set; } = default!;
    private string currentUser = string.Empty;
    private bool isSubmitting = false;
    private string generatedSID = "系统将自动生成";

    [SupplyParameterFromForm]
    public Student Student { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        // 预览下一个学号
        var maxSID = await DB.SMS_Students.AnyAsync() 
            ? await DB.SMS_Students.MaxAsync(s => s.SID) 
            : 0;
        generatedSID = $"S{(maxSID + 1):D6}"; // 格式：S000001
    }

    // To protect from overposting attacks, see https://aka.ms/RazorPagesCRUD
    public async Task AddStudent()
    {
        isSubmitting = true;
        StateHasChanged();
        
        try
        {
            // 自动生成学号
            var maxSID = await DB.SMS_Students.AnyAsync() 
                ? await DB.SMS_Students.MaxAsync(s => s.SID) 
                : 0;
            Student.SID = maxSID + 1;

            currentUser = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "currentUser") ?? string.Empty;
            if (!string.IsNullOrEmpty(currentUser))
            {
                Student.CreateUser = currentUser;
                Student.UpdateUser = currentUser;
            }
            DB.SMS_Students.Add(Student);
            await DB.SaveChangesAsync();
            await JSRuntime.InvokeVoidAsync("alert", "创建成功！");
            NavigationManager.NavigateTo("/admin-students");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"创建失败: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }
}
