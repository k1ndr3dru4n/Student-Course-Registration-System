@page "/admin-teacher-enrollment"
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using AntDesign
@using System.Linq
@inject SMS.CimContext DB
@using SMS.Models
@rendermode InteractiveServer
@inject IJSRuntime JS
@inject NavigationManager Navigation

<PageTitle>教师课程管理</PageTitle>

<div style="padding: 24px;">
    <!-- 面包屑导航 -->
    <AntDesign.Breadcrumb style="margin-bottom: 24px;">
        <BreadcrumbItem>
            <a href="/admin-directory">目录</a>
        </BreadcrumbItem>
        <BreadcrumbItem>
            <a href="/admin-enrollment-management">选课管理</a>
        </BreadcrumbItem>
        <BreadcrumbItem>教师课程管理</BreadcrumbItem>
    </AntDesign.Breadcrumb>

    <h1><Icon Type="team" /> 教师课程管理</h1>
    <p style="color: #666;">管理课程的学生选课情况，录入成绩</p>

    <!-- 教师选择 -->
    <div style="margin-bottom: 24px; padding: 16px; border: 1px solid #f0f0f0; border-radius: 6px;">
        <h3>搜索并选择教师</h3>
        <div style="display: flex; gap: 16px; align-items: center; position: relative;">
            <div style="flex: 1; position: relative;">
                <input type="text" 
                       @bind="teacherSearchText" 
                       @oninput="OnTeacherSearchTextChanged"
                       @onfocus="ShowTeacherSearchResults"
                       @onblur="@(async () => { await Task.Delay(200); showTeacherSearchResults = false; })"
                       placeholder="输入教师姓名或工号进行搜索..." 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 14px;" />
                
                @if (showTeacherSearchResults && filteredTeachers != null && filteredTeachers.Any())
                {
                    <div style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d9d9d9; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 1000;">
                        @foreach (var teacher in filteredTeachers.Take(10))
                        {
                            <div @onclick="() => SelectTeacher(teacher)" 
                                 style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;"
                                 onmouseover="this.style.backgroundColor='#f5f5f5'" 
                                 onmouseout="this.style.backgroundColor='white'">
                                <div style="font-weight: 500;">@teacher.Name</div>
                                <div style="font-size: 12px; color: #666;">工号: @teacher.TID | 专业: @teacher.Major</div>
                            </div>
                        }
                    </div>
                }
            </div>
            
            @if (selectedTeacher != null)
            {
                <div style="padding: 8px 12px; background: #e6f7ff; border: 1px solid #91d5ff; border-radius: 4px; display: flex; align-items: center; gap: 8px;">
                    <span>已选择: @selectedTeacher.Name (工号: @selectedTeacher.TID)</span>
                    <button @onclick="ClearSelectedTeacher" 
                            style="background: none; border: none; color: #1890ff; cursor: pointer; padding: 2px;">
                        ✕
                    </button>
                </div>
            }
        </div>
    </div>

    @if (selectedTeacher != null)
    {
        <!-- 标签页 -->
        <div style="border-bottom: 1px solid #f0f0f0; margin-bottom: 24px;">
            <div style="display: flex; gap: 0;">
                <button @onclick="() => SwitchTab(0)" 
                        style="padding: 12px 24px; border: none; border-bottom: 2px solid @(activeTab == 0 ? "#1890ff" : "transparent"); background: transparent; cursor: pointer; font-weight: @(activeTab == 0 ? "600" : "normal"); color: @(activeTab == 0 ? "#1890ff" : "#666");">
                    课程管理
                </button>
                <button @onclick="() => SwitchTab(1)" 
                        style="padding: 12px 24px; border: none; border-bottom: 2px solid @(activeTab == 1 ? "#1890ff" : "transparent"); background: transparent; cursor: pointer; font-weight: @(activeTab == 1 ? "600" : "normal"); color: @(activeTab == 1 ? "#1890ff" : "#666");">
                    选择课程
                </button>
                <button @onclick="() => SwitchTab(2)" 
                        style="padding: 12px 24px; border: none; border-bottom: 2px solid @(activeTab == 2 ? "#1890ff" : "transparent"); background: transparent; cursor: pointer; font-weight: @(activeTab == 2 ? "600" : "normal"); color: @(activeTab == 2 ? "#1890ff" : "#666");">
                    成绩管理
                </button>
                <button @onclick="() => SwitchTab(3)" 
                        style="padding: 12px 24px; border: none; border-bottom: 2px solid @(activeTab == 3 ? "#1890ff" : "transparent"); background: transparent; cursor: pointer; font-weight: @(activeTab == 3 ? "600" : "normal"); color: @(activeTab == 3 ? "#1890ff" : "#666");">
                    教师申请审批
                </button>
            </div>
        </div>

        @if (activeTab == 0)
        {
            <div style="border: 1px solid #f0f0f0; border-radius: 6px; padding: 16px;">

                <!-- 搜索框 -->
                <div style="margin-bottom: 16px; display: flex; gap: 12px; align-items: center;">
                    <input type="text" 
                           @bind="courseManagementSearchText" 
                           placeholder="搜索课程名称、课程号等..." 
                           style="flex: 1; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 14px;" />
                    <button @onclick="SearchCourseManagement" 
                            style="padding: 8px 16px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        搜索
                    </button>
                    <button @onclick="ClearCourseManagementSearch" 
                            style="padding: 8px 16px; background: #f5f5f5; color: #666; border: 1px solid #d9d9d9; border-radius: 4px; cursor: pointer;">
                        清除
                    </button>
                </div>

                @if (teacherCourses == null)
                {
                    <div style="text-align: center; padding: 40px; color: #666;">
                        正在加载我的课程...
                    </div>
                }
                else if (!teacherCourses.Any())
                {
                    <div style="text-align: center; padding: 40px; color: #666;">
                        暂未分配任何课程
                        <div style="margin-top: 8px; font-size: 12px; color: #999;">
                            请在"选择课程"标签页中申请课程
                        </div>
                    </div>
                }
                else
                {
                    <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                        <thead>
                            <tr style="background: #fafafa;">
                                <th style="padding: 12px; border: 1px solid #f0f0f0; text-align: left;">
                                    <div style="display: flex; align-items: center;">
                                        <span>课程名称</span>
                                        <span style="margin-left: 8px; flex-direction: column;">
                                            <span style="cursor: pointer; color: @(courseManagementSortField=="Name"&&courseManagementSortAsc?"#1890ff":"#ccc");" @onclick='() => SortCourseManagement("Name", true)'>▲</span>
                                            <span style="cursor: pointer; color: @(courseManagementSortField=="Name"&&!courseManagementSortAsc?"#1890ff":"#ccc");" @onclick='() => SortCourseManagement("Name", false)'>▼</span>
                                        </span>
                                    </div>
                                </th>
                                <th style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">
                                    <div style="display: flex; align-items: center; justify-content: center;">
                                        <span>课程号</span>
                                        <span style="margin-left: 8px; flex-direction: column;">
                                            <span style="cursor: pointer; color: @(courseManagementSortField=="CID"&&courseManagementSortAsc?"#1890ff":"#ccc");" @onclick='() => SortCourseManagement("CID", true)'>▲</span>
                                            <span style="cursor: pointer; color: @(courseManagementSortField=="CID"&&!courseManagementSortAsc?"#1890ff":"#ccc");" @onclick='() => SortCourseManagement("CID", false)'>▼</span>
                                        </span>
                                    </div>
                                </th>
                                <th style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">
                                    <div style="display: flex; align-items: center; justify-content: center;">
                                        <span>学分</span>
                                        <span style="margin-left: 8px; flex-direction: column;">
                                            <span style="cursor: pointer; color: @(courseManagementSortField=="Credits"&&courseManagementSortAsc?"#1890ff":"#ccc");" @onclick='() => SortCourseManagement("Credits", true)'>▲</span>
                                            <span style="cursor: pointer; color: @(courseManagementSortField=="Credits"&&!courseManagementSortAsc?"#1890ff":"#ccc");" @onclick='() => SortCourseManagement("Credits", false)'>▼</span>
                                        </span>
                                    </div>
                                </th>
                                <th style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">
                                    <div style="display: flex; align-items: center; justify-content: center;">
                                        <span>课程状态</span>
                                        <span style="margin-left: 8px; flex-direction: column;">
                                            <span style="cursor: pointer; color: @(courseManagementSortField=="CourseStatus"&&courseManagementSortAsc?"#1890ff":"#ccc");" @onclick='() => SortCourseManagement("CourseStatus", true)'>▲</span>
                                            <span style="cursor: pointer; color: @(courseManagementSortField=="CourseStatus"&&!courseManagementSortAsc?"#1890ff":"#ccc");" @onclick='() => SortCourseManagement("CourseStatus", false)'>▼</span>
                                        </span>
                                    </div>
                                </th>
                                <th style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var course in GetSortedCourseManagementData())
                            {
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #f0f0f0;">@course.Name</td>
                                    <td style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">@course.CID</td>
                                    <td style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">@course.Credits</td>
                                    <td style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">
                                        @switch (course.CourseStatus)
                                        {
                                            case CourseStatus.未开课:
                                                <span style="color: #faad14; font-weight: 500;">未开课</span>
                                                break;
                                            case CourseStatus.正在进行:
                                                <span style="color: #52c41a; font-weight: 500;">正在进行</span>
                                                break;
                                            case CourseStatus.已结束:
                                                <span style="color: #8c8c8c; font-weight: 500;">已结束</span>
                                                break;
                                        }
                                    </td>
                                    <td style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">
                                        <span style="color: #52c41a; font-weight: 500;">已申请</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        }

        @if (activeTab == 1)
        {
            <div style="border: 1px solid #f0f0f0; border-radius: 6px; padding: 16px;">

                <!-- 搜索框 -->
                <div style="margin-bottom: 16px; display: flex; gap: 12px; align-items: center;">
                    <input type="text" 
                           @bind="availableCoursesSearchText" 
                           placeholder="搜索课程名称、课程号、教师等..." 
                           style="flex: 1; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 14px;" />
                    <button @onclick="SearchAvailableCourses" 
                            style="padding: 8px 16px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        搜索
                    </button>
                    <button @onclick="ClearAvailableCoursesSearch" 
                            style="padding: 8px 16px; background: #f5f5f5; color: #666; border: 1px solid #d9d9d9; border-radius: 4px; cursor: pointer;">
                        清除
                    </button>
                </div>

                @if (availableCourses == null)
                {
                    <div style="text-align: center; padding: 40px; color: #666;">
                        正在加载课程数据...
                    </div>
                }
                else if (!availableCourses.Any())
                {
                    <div style="text-align: center; padding: 40px; color: #666;">
                        暂无可申请课程
                    </div>
                }
                else
                {
                                         <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
                         <thead>
                             <tr style="background: #fafafa;">
                                 <th style="padding: 12px; border: 1px solid #f0f0f0; text-align: left;">
                                     <div style="display: flex; align-items: center;">
                                         <span>课程名称</span>
                                         <span style="margin-left: 8px; flex-direction: column;">
                                             <span style="cursor: pointer; color: @(availableCoursesSortField=="Name"&&availableCoursesSortAsc?"#1890ff":"#ccc");" @onclick='() => SortAvailableCourses("Name", true)'>▲</span>
                                             <span style="cursor: pointer; color: @(availableCoursesSortField=="Name"&&!availableCoursesSortAsc?"#1890ff":"#ccc");" @onclick='() => SortAvailableCourses("Name", false)'>▼</span>
                                         </span>
                                     </div>
                                 </th>
                                 <th style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">
                                     <div style="display: flex; align-items: center; justify-content: center;">
                                         <span>课程号</span>
                                         <span style="margin-left: 8px; flex-direction: column;">
                                             <span style="cursor: pointer; color: @(availableCoursesSortField=="CID"&&availableCoursesSortAsc?"#1890ff":"#ccc");" @onclick='() => SortAvailableCourses("CID", true)'>▲</span>
                                             <span style="cursor: pointer; color: @(availableCoursesSortField=="CID"&&!availableCoursesSortAsc?"#1890ff":"#ccc");" @onclick='() => SortAvailableCourses("CID", false)'>▼</span>
                                         </span>
                                     </div>
                                 </th>
                                 <th style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">
                                     <div style="display: flex; align-items: center; justify-content: center;">
                                         <span>学分</span>
                                         <span style="margin-left: 8px; flex-direction: column;">
                                             <span style="cursor: pointer; color: @(availableCoursesSortField=="Credits"&&availableCoursesSortAsc?"#1890ff":"#ccc");" @onclick='() => SortAvailableCourses("Credits", true)'>▲</span>
                                             <span style="cursor: pointer; color: @(availableCoursesSortField=="Credits"&&!availableCoursesSortAsc?"#1890ff":"#ccc");" @onclick='() => SortAvailableCourses("Credits", false)'>▼</span>
                                         </span>
                                     </div>
                                 </th>
                                 <th style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">
                                     <div style="display: flex; align-items: center; justify-content: center;">
                                         <span>课程状态</span>
                                         <span style="margin-left: 8px; flex-direction: column;">
                                             <span style="cursor: pointer; color: @(availableCoursesSortField=="CourseStatus"&&availableCoursesSortAsc?"#1890ff":"#ccc");" @onclick='() => SortAvailableCourses("CourseStatus", true)'>▲</span>
                                             <span style="cursor: pointer; color: @(availableCoursesSortField=="CourseStatus"&&!availableCoursesSortAsc?"#1890ff":"#ccc");" @onclick='() => SortAvailableCourses("CourseStatus", false)'>▼</span>
                                         </span>
                                     </div>
                                 </th>
                                 <th style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">
                                     <div style="display: flex; align-items: center; justify-content: center;">
                                         <span>授课教师</span>
                                         <span style="margin-left: 8px; flex-direction: column;">
                                             <span style="cursor: pointer; color: @(availableCoursesSortField=="Teacher"&&availableCoursesSortAsc?"#1890ff":"#ccc");" @onclick='() => SortAvailableCourses("Teacher", true)'>▲</span>
                                             <span style="cursor: pointer; color: @(availableCoursesSortField=="Teacher"&&!availableCoursesSortAsc?"#1890ff":"#ccc");" @onclick='() => SortAvailableCourses("Teacher", false)'>▼</span>
                                         </span>
                                     </div>
                                 </th>
                                 <th style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">操作</th>
                             </tr>
                         </thead>
                                                 <tbody>
                             @foreach (var course in GetSortedAvailableCoursesData())
                             {
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #f0f0f0;">@course.Name</td>
                                    <td style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">@course.CID</td>
                                    <td style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">@course.Credits</td>
                                    <td style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">
                                        @switch (course.CourseStatus)
                                        {
                                            case CourseStatus.未开课:
                                                <span style="color: #faad14; font-weight: 500;">未开课</span>
                                                break;
                                            case CourseStatus.正在进行:
                                                <span style="color: #52c41a; font-weight: 500;">正在进行</span>
                                                break;
                                            case CourseStatus.已结束:
                                                <span style="color: #8c8c8c; font-weight: 500;">已结束</span>
                                                break;
                                        }
                                    </td>
                                    <td style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">
                                        @if (course.Teacher != null)
                                        {
                                            <span>@course.Teacher.Name</span>
                                        }
                                        else
                                        {
                                            <span style="color: #8c8c8c;">暂无教师</span>
                                        }
                                    </td>
                                    <td style="padding: 12px; border: 1px solid #f0f0f0; text-align: center;">
                                        @if (course.CourseStatus == CourseStatus.未开课 && course.TeacherId == null)
                                        {
                                            <button @onclick="() => ApplyCourse(course)" 
                                                    style="padding: 6px 12px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                                申请
                                            </button>
                                        }
                                        else if (course.TeacherId != null)
                                        {
                                            <span style="color: #8c8c8c; font-weight: 500;">已被申请</span>
                                        }
                                        else
                                        {
                                            <span style="color: #8c8c8c; font-weight: 500;">不可申请</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        }
        
        @if (activeTab == 2)
        {
            <div style="border: 1px solid #f0f0f0; border-radius: 6px; padding: 16px;">
                <p style="color: #666; margin-bottom: 16px;">只有已结束的课程才能录入成绩</p>
                
                @if (finishedCourses == null || !finishedCourses.Any())
                {
                    <p style="color: #999; text-align: center; padding: 20px;">暂无已结束的课程</p>
                }
                else
                {
                    <!-- 搜索框 -->
                    <div style="margin-bottom: 16px; display: flex; gap: 12px; align-items: center;">
                        <input type="text" 
                               @bind="gradeManagementSearchText" 
                               placeholder="搜索课程名称、课程号等..." 
                               style="flex: 1; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 14px;" />
                        <button @onclick="SearchGradeManagement" 
                                style="padding: 8px 16px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            搜索
                        </button>
                        <button @onclick="ClearGradeManagementSearch" 
                                style="padding: 8px 16px; background: #f5f5f5; color: #666; border: 1px solid #d9d9d9; border-radius: 4px; cursor: pointer;">
                            清除
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">选择课程:</label>
                        <select value="@selectedCourseForGrade" style="width: 300px; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;" @onchange="@OnCourseSelectionChanged">
                            <option value="0">请选择已结束的课程</option>
                            @foreach (var course in finishedCourses)
                            {
                                <option value="@course.Id">@course.Name (@course.CID)</option>
                            }
                        </select>
                    </div>

                    @if (selectedCourseForGrade > 0 && courseEnrollments != null && courseEnrollments.Any())
                    {
                                                 <table style="width: 100%; border-collapse: collapse; margin-top: 16px; border: 1px solid #ddd;">
                             <thead style="background: #f5f5f5;">
                                 <tr>
                                     <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">
                                         <div style="display: flex; align-items: center;">
                                             <span>学生姓名</span>
                                             <span style="margin-left: 8px; flex-direction: column;">
                                                 <span style="cursor: pointer; color: @(gradeManagementSortField=="StudentName"&&gradeManagementSortAsc?"#1890ff":"#ccc");" @onclick='() => SortGradeManagement("StudentName", true)'>▲</span>
                                                 <span style="cursor: pointer; color: @(gradeManagementSortField=="StudentName"&&!gradeManagementSortAsc?"#1890ff":"#ccc");" @onclick='() => SortGradeManagement("StudentName", false)'>▼</span>
                                             </span>
                                         </div>
                                     </th>
                                     <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                                         <div style="display: flex; align-items: center; justify-content: center;">
                                             <span>学号</span>
                                             <span style="margin-left: 8px; flex-direction: column;">
                                                 <span style="cursor: pointer; color: @(gradeManagementSortField=="StudentSID"&&gradeManagementSortAsc?"#1890ff":"#ccc");" @onclick='() => SortGradeManagement("StudentSID", true)'>▲</span>
                                                 <span style="cursor: pointer; color: @(gradeManagementSortField=="StudentSID"&&!gradeManagementSortAsc?"#1890ff":"#ccc");" @onclick='() => SortGradeManagement("StudentSID", false)'>▼</span>
                                             </span>
                                         </div>
                                     </th>
                                     <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">选课状态</th>
                                     <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                                         <div style="display: flex; align-items: center; justify-content: center;">
                                             <span>当前成绩</span>
                                             <span style="margin-left: 8px; flex-direction: column;">
                                                 <span style="cursor: pointer; color: @(gradeManagementSortField=="Grade"&&gradeManagementSortAsc?"#1890ff":"#ccc");" @onclick='() => SortGradeManagement("Grade", true)'>▲</span>
                                                 <span style="cursor: pointer; color: @(gradeManagementSortField=="Grade"&&!gradeManagementSortAsc?"#1890ff":"#ccc");" @onclick='() => SortGradeManagement("Grade", false)'>▼</span>
                                             </span>
                                         </div>
                                     </th>
                                     <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">录入成绩</th>
                                     <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">操作</th>
                                 </tr>
                             </thead>
                                                         <tbody>
                                 @foreach (var enrollment in GetSortedGradeManagementData())
                                 {
                                    <tr>
                                        <td style="padding: 12px; border: 1px solid #ddd;">@(enrollment.Student?.Name ?? "未知学生")</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">@enrollment.StudentSID</td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                                            <span style="color: #52c41a; padding: 4px 8px; background: #f6ffed; border-radius: 4px;">已选课</span>
                                        </td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                                            @if (enrollment.Grade.HasValue)
                                            {
                                                <span style="font-weight: 500; color: @GetGradeColor((int)enrollment.Grade.Value);">@enrollment.Grade.Value 分</span>
                                            }
                                            else
                                            {
                                                <span style="color: #999;">未录入</span>
                                            }
                                        </td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                                            <input type="number" min="0" max="100" step="1" 
                                                   @bind="gradeInputs[enrollment.Id]" 
                                                   placeholder="0-100分"
                                                   style="width: 80px; padding: 4px 8px; border: 1px solid #d9d9d9; border-radius: 4px; text-align: center;" />
                                        </td>
                                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                                            <button type="button" style="margin: 2px; background: #52c41a; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;" 
                                                    @onclick="@(() => SaveGrade(enrollment.Id))">
                                                保存成绩
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else if (selectedCourseForGrade > 0)
                    {
                        <p style="color: #999; text-align: center; padding: 20px;">该课程暂无有效的选课学生</p>
                    }
                }
            </div>
        }
    }

    <!-- 教师申请审批标签页 -->
    @if (activeTab == 3)
    {
        <div style="border: 1px solid #f0f0f0; border-radius: 6px; padding: 16px;">
            <!-- 统计卡片 -->
            <div style="display: flex; gap: 16px; margin-bottom: 24px;">
                <AntDesign.Card style="flex: 1; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #1890ff;">@pendingCount</div>
                    <div style="color: #666;">待审批</div>
                </AntDesign.Card>
                <AntDesign.Card style="flex: 1; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #52c41a;">@approvedCount</div>
                    <div style="color: #666;">已通过</div>
                </AntDesign.Card>
                <AntDesign.Card style="flex: 1; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #ff4d4f;">@rejectedCount</div>
                    <div style="color: #666;">已拒绝</div>
                </AntDesign.Card>
            </div>

            <!-- 筛选器 -->
            <div style="margin-bottom: 16px; display: flex; gap: 16px; align-items: center;">
                <div>
                    <label style="margin-right: 8px;">状态筛选：</label>
                    <select @onchange="OnStatusFilterChangedEvent" style="width: 150px; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                        <option value="">全部</option>
                        <option value="@((int)ApplicationStatus.Pending)" selected="@(statusFilter == (int)ApplicationStatus.Pending)">待审批</option>
                        <option value="@((int)ApplicationStatus.Approved)" selected="@(statusFilter == (int)ApplicationStatus.Approved)">已通过</option>
                        <option value="@((int)ApplicationStatus.Rejected)" selected="@(statusFilter == (int)ApplicationStatus.Rejected)">已拒绝</option>
                    </select>
                </div>
                <div>
                    <AntDesign.Button Type="@AntDesign.ButtonType.Primary" @onclick="LoadApplications">
                        刷新数据
                    </AntDesign.Button>
                </div>
            </div>

            <!-- 申请列表 -->
            @if (applications == null)
            {
                <div style="text-align:center; color:#888; padding:32px;">正在加载申请数据...</div>
            }
            else if (!filteredApplications.Any())
            {
                <div style="text-align:center; color:#888; padding:32px;">暂无申请记录</div>
            }
            else
            {
                <div style="overflow-x: auto;">
                    <table class="ant-table-tbody" style="width: 100%; border-collapse: collapse;">
                        <thead style="background-color: #fafafa;">
                            <tr>
                                <th style="padding: 16px; border: 1px solid #f0f0f0; text-align: left; font-weight: 500;">申请教师</th>
                                <th style="padding: 16px; border: 1px solid #f0f0f0; text-align: left; font-weight: 500;">课程名称</th>
                                <th style="padding: 16px; border: 1px solid #f0f0f0; text-align: left; font-weight: 500;">课程号</th>
                                <th style="padding: 16px; border: 1px solid #f0f0f0; text-align: left; font-weight: 500;">学分</th>
                                <th style="padding: 16px; border: 1px solid #f0f0f0; text-align: left; font-weight: 500;">课程描述</th>
                                <th style="padding: 16px; border: 1px solid #f0f0f0; text-align: left; font-weight: 500;">申请状态</th>
                                <th style="padding: 16px; border: 1px solid #f0f0f0; text-align: left; font-weight: 500;">申请时间</th>
                                <th style="padding: 16px; border: 1px solid #f0f0f0; text-align: center; font-weight: 500;">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var application in filteredApplications)
                            {
                                <tr style="border-bottom: 1px solid #f0f0f0;">
                                    <td style="padding: 16px; border: 1px solid #f0f0f0;">@(application.Teacher?.Name ?? "未知教师")</td>
                                    <td style="padding: 16px; border: 1px solid #f0f0f0;">@application.Name</td>
                                    <td style="padding: 16px; border: 1px solid #f0f0f0;">
                                        @if (string.IsNullOrEmpty(application.CID))
                                        {
                                            <span style="color: #999; font-style: italic;">待分配</span>
                                        }
                                        else
                                        {
                                            @application.CID
                                        }
                                    </td>
                                    <td style="padding: 16px; border: 1px solid #f0f0f0;">@application.Credits</td>
                                    <td style="padding: 16px; border: 1px solid #f0f0f0; max-width: 200px; word-wrap: break-word;">
                                        @(string.IsNullOrEmpty(application.Description) ? "-" : application.Description)
                                    </td>
                                    <td style="padding: 16px; border: 1px solid #f0f0f0;">
                                        @switch (application.Status)
                                        {
                                            case ApplicationStatus.Pending:
                                                <AntDesign.Tag Color="@("orange")">待审批</AntDesign.Tag>
                                                break;
                                            case ApplicationStatus.Approved:
                                                <AntDesign.Tag Color="@("green")">已通过</AntDesign.Tag>
                                                break;
                                            case ApplicationStatus.Rejected:
                                                <AntDesign.Tag Color="@("red")">已拒绝</AntDesign.Tag>
                                                break;
                                        }
                                    </td>
                                    <td style="padding: 16px; border: 1px solid #f0f0f0;">@application.CreateDate.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td style="padding: 16px; border: 1px solid #f0f0f0; text-align: center;">
                                        @if (application.Status == ApplicationStatus.Pending)
                                        {
                                            <div style="display: flex; gap: 8px; justify-content: center;">
                                                <AntDesign.Button Type="@AntDesign.ButtonType.Primary" @onclick="() => ShowApprovalModal(application, true)">
                                                    通过
                                                </AntDesign.Button>
                                                <AntDesign.Button Type="@AntDesign.ButtonType.Default" Danger @onclick="() => ShowApprovalModal(application, false)">
                                                    拒绝
                                                </AntDesign.Button>
                                            </div>
                                        }
                                        else
                                        {
                                            <div style="color: #999;">已处理</div>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }
</div>

<!-- 审批模态框 -->
<AntDesign.Modal Title="@(isApproving ? "通过申请" : "拒绝申请")" 
                @bind-Visible="approvalModalVisible" 
                Width="500"
                OnCancel="CloseApprovalModal"
                Footer="null">
    @if (currentApplication != null)
    {
        <div style="margin-bottom: 16px;">
            <strong>申请信息：</strong>
        </div>
        <div style="background-color: #f5f5f5; padding: 16px; margin-bottom: 16px; border-radius: 4px;">
            <p><strong>教师：</strong> @(currentApplication.Teacher?.Name ?? "未知教师")</p>
            <p><strong>课程名称：</strong> @currentApplication.Name</p>
            <p><strong>课程号：</strong> @currentApplication.CID</p>
            <p><strong>学分：</strong> @currentApplication.Credits</p>
            <p><strong>描述：</strong> @(string.IsNullOrEmpty(currentApplication.Description) ? "无" : currentApplication.Description)</p>
        </div>

        <EditForm Model="@approvalModel" OnValidSubmit="HandleApproval" FormName="approvalForm">
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">
                    @(isApproving ? "通过" : "拒绝")理由：
                </label>
                <AntDesign.TextArea @bind-Value="approvalModel.Comment" 
                                  Placeholder="@(isApproving ? "请输入通过理由（可选）" : "请输入拒绝理由")" 
                                  Rows="3" />
            </div>

            <div style="text-align: right;">
                <AntDesign.Button @onclick="CloseApprovalModal" style="margin-right: 8px;">
                    取消
                </AntDesign.Button>
                <AntDesign.Button Type="@AntDesign.ButtonType.Primary" 
                                HtmlType="submit" 
                                Loading="isSubmitting"
                                Danger="@(!isApproving)">
                    确认@(isApproving ? "通过" : "拒绝")
                </AntDesign.Button>
            </div>
        </EditForm>
    }
</AntDesign.Modal>

@code {
    // 教师相关
    private List<Teacher>? teachers;
    private Teacher? selectedTeacher;
    private int _selectedTeacherTID = 0;
    private List<Course>? teacherCourses;
    
    // 教师搜索相关
    private string teacherSearchText = "";
    private List<Teacher>? filteredTeachers = new();
    private bool showTeacherSearchResults = false;
    
    private int selectedTeacherTID
    {
        get => selectedTeacher?.TID ?? 0;
        set
        {
            var teacher = teachers?.FirstOrDefault(t => t.TID == value);
            if (selectedTeacher != teacher)
            {
                selectedTeacher = teacher;
                _selectedTeacherTID = value;
                _ = OnTeacherChanged();
            }
        }
    }
    
    // 标签页控制
    private int activeTab = 0; // 0: 课程管理, 1: 选择课程, 2: 成绩管理, 3: 教师申请审批
    
    // 可选课程
    private List<Course>? availableCourses;
    
    // 成绩管理相关
    private List<Course>? finishedCourses = new();
    private List<Enrollment> courseEnrollments = new();
    private int selectedCourseForGrade = 0;
    private Dictionary<int, int> gradeInputs = new();

    // 教师申请审批相关变量
    private List<TeacherApplication> applications = new();
    private List<TeacherApplication> filteredApplications = new();
    
    // 统计数据
    private int pendingCount = 0;
    private int approvedCount = 0;
    private int rejectedCount = 0;
    
    // 筛选
    private int? statusFilter = null;
    
    // 审批相关
    private bool approvalModalVisible = false;
    private bool isApproving = false;
    private bool isSubmitting = false;
    private TeacherApplication? currentApplication = null;
    private ApprovalModel approvalModel = new();
    
    // 审批模型
    public class ApprovalModel
    {
        public string Comment { get; set; } = "";
    }
    
    // 课程管理排序相关
    private string courseManagementSortField = "Name";
    private bool courseManagementSortAsc = true;
    
    // 选择课程排序相关
    private string availableCoursesSortField = "Name";
    private bool availableCoursesSortAsc = true;
    
    // 成绩管理排序相关
    private string gradeManagementSortField = "StudentName";
    private bool gradeManagementSortAsc = true;

    // 搜索文本
    private string courseSearchText = string.Empty;
    private string courseManagementSearchText = string.Empty;
    private string availableCoursesSearchText = string.Empty;
    private string gradeManagementSearchText = string.Empty;
    
    // 原始数据用于搜索
    private List<Course>? originalTeacherCourses;
    private List<Course>? originalAvailableCourses;
    private List<Course>? originalFinishedCourses;
    private List<Enrollment>? originalCourseEnrollments;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadTeachers();
        await LoadAvailableCourses();
        await LoadApplications();
        StateHasChanged();
    }
    
    private async Task LoadTeachers()
    {
        teachers = await DB.SMS_Teachers.OrderBy(t => t.Name).ToListAsync();
        StateHasChanged();
    }
    
    // 教师搜索相关方法
    private void OnTeacherSearchTextChanged(ChangeEventArgs e)
    {
        teacherSearchText = e.Value?.ToString() ?? "";
        FilterTeachers();
    }
    
    private void FilterTeachers()
    {
        if (string.IsNullOrWhiteSpace(teacherSearchText) || teachers == null)
        {
            filteredTeachers = new List<Teacher>();
            showTeacherSearchResults = false;
            return;
        }
        
        var searchText = teacherSearchText.ToLower();
        filteredTeachers = teachers.Where(t => 
            (t.Name?.ToLower().Contains(searchText) ?? false) || 
            t.TID.ToString().Contains(searchText) ||
            (t.Major?.ToLower().Contains(searchText) ?? false)
        ).Take(10).ToList();
        
        showTeacherSearchResults = filteredTeachers.Any();
        StateHasChanged();
    }
    
    private void ShowTeacherSearchResults()
    {
        if (!string.IsNullOrWhiteSpace(teacherSearchText) && filteredTeachers?.Any() == true)
        {
            showTeacherSearchResults = true;
        }
    }
    
    private async Task SelectTeacher(Teacher teacher)
    {
        selectedTeacher = teacher;
        teacherSearchText = $"{teacher.Name} (工号: {teacher.TID})";
        showTeacherSearchResults = false;
        await OnTeacherChanged();
        StateHasChanged();
    }
    
    private void ClearSelectedTeacher()
    {
        selectedTeacher = null;
        teacherSearchText = "";
        filteredTeachers = new List<Teacher>();
        showTeacherSearchResults = false;
        teacherCourses = null;
        availableCourses = null;
        finishedCourses = null;
        StateHasChanged();
    }

    private async Task LoadAvailableCourses()
    {
        try
        {
            // 只加载未开课的课程，包含Teacher信息
            availableCourses = await DB.SMS_Courses
                .Include(c => c.Teacher)
                .Where(c => c.CourseStatus == CourseStatus.未开课)
                .OrderBy(c => c.Name)
                .ToListAsync();
            
            // 保存原始数据用于搜索
            originalAvailableCourses = availableCourses.ToList();
                
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"加载课程失败: {ex.Message}");
            availableCourses = new List<Course>();
            originalAvailableCourses = new List<Course>();
            StateHasChanged();
        }
    }
    
    private async Task LoadTeacherData()
    {
        if (selectedTeacherTID == 0) return;
        
        try
        {
            await LoadTeacherAssignedCourses();
            await LoadFinishedCourses();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"加载教师数据失败: {ex.Message}");
        }
    }

    private async Task LoadTeacherAssignedCourses()
    {
        if (selectedTeacherTID == 0) return;

        try
        {
            var teacher = await DB.SMS_Teachers
                .FirstOrDefaultAsync(t => t.TID == selectedTeacherTID);

            if (teacher == null)
            {
                teacherCourses = new List<Course>();
                originalTeacherCourses = new List<Course>();
                StateHasChanged();
                return;
            }

            teacherCourses = await DB.SMS_Courses
                .Where(c => c.TeacherId == teacher.Id)
                .OrderBy(c => c.Name)
                .ToListAsync();

            // 保存原始数据用于搜索
            originalTeacherCourses = teacherCourses.ToList();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"加载教师分配课程失败: {ex.Message}");
            teacherCourses = new List<Course>();
            originalTeacherCourses = new List<Course>();
            StateHasChanged();
        }
    }

    private void SearchCourseManagement()
    {
        if (originalTeacherCourses == null) return;
        
        if (string.IsNullOrEmpty(courseManagementSearchText))
        {
            teacherCourses = originalTeacherCourses.ToList();
        }
        else
        {
            teacherCourses = originalTeacherCourses.Where(c =>
                c.CID.ToString().Contains(courseManagementSearchText) ||
                c.Id.ToString().Contains(courseManagementSearchText) ||
                (c.Name != null && c.Name.Contains(courseManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                c.Credits.ToString().Contains(courseManagementSearchText) ||
                (c.Description != null && c.Description.Contains(courseManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                c.CourseStatus.ToString().Contains(courseManagementSearchText, StringComparison.OrdinalIgnoreCase) ||
                (c.TeacherId?.ToString().Contains(courseManagementSearchText) ?? false) ||
                (c.Teacher?.Name != null && c.Teacher.Name.Contains(courseManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                (c.Teacher?.TID.ToString().Contains(courseManagementSearchText) ?? false) ||
                (c.Teacher?.Major != null && c.Teacher.Major.Contains(courseManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                (c.Teacher?.Email != null && c.Teacher.Email.Contains(courseManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                (c.Teacher?.Age.ToString().Contains(courseManagementSearchText) ?? false) ||
                (c.CreateUser != null && c.CreateUser.Contains(courseManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                (c.UpdateUser != null && c.UpdateUser.Contains(courseManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                c.CreateDate.ToString().Contains(courseManagementSearchText) ||
                c.UpdateDate.ToString().Contains(courseManagementSearchText)
            ).ToList();
        }
        StateHasChanged();
    }
    
    private void SearchAvailableCourses()
    {
        if (originalAvailableCourses == null) return;
        
        if (string.IsNullOrEmpty(availableCoursesSearchText))
        {
            availableCourses = originalAvailableCourses.ToList();
        }
        else
        {
            availableCourses = originalAvailableCourses.Where(c =>
                c.CID.ToString().Contains(availableCoursesSearchText) ||
                c.Id.ToString().Contains(availableCoursesSearchText) ||
                (c.Name != null && c.Name.Contains(availableCoursesSearchText, StringComparison.OrdinalIgnoreCase)) ||
                c.Credits.ToString().Contains(availableCoursesSearchText) ||
                (c.Description != null && c.Description.Contains(availableCoursesSearchText, StringComparison.OrdinalIgnoreCase)) ||
                c.CourseStatus.ToString().Contains(availableCoursesSearchText, StringComparison.OrdinalIgnoreCase) ||
                (c.TeacherId?.ToString().Contains(availableCoursesSearchText) ?? false) ||
                (c.Teacher?.Name != null && c.Teacher.Name.Contains(availableCoursesSearchText, StringComparison.OrdinalIgnoreCase)) ||
                (c.Teacher?.TID.ToString().Contains(availableCoursesSearchText) ?? false) ||
                (c.Teacher?.Major != null && c.Teacher.Major.Contains(availableCoursesSearchText, StringComparison.OrdinalIgnoreCase)) ||
                (c.Teacher?.Email != null && c.Teacher.Email.Contains(availableCoursesSearchText, StringComparison.OrdinalIgnoreCase)) ||
                (c.Teacher?.Age.ToString().Contains(availableCoursesSearchText) ?? false) ||
                (c.CreateUser != null && c.CreateUser.Contains(availableCoursesSearchText, StringComparison.OrdinalIgnoreCase)) ||
                (c.UpdateUser != null && c.UpdateUser.Contains(availableCoursesSearchText, StringComparison.OrdinalIgnoreCase)) ||
                c.CreateDate.ToString().Contains(availableCoursesSearchText) ||
                c.UpdateDate.ToString().Contains(availableCoursesSearchText)
            ).ToList();
        }
        StateHasChanged();
    }
    
    private void SearchGradeManagement()
    {
    if (originalCourseEnrollments == null) return;
        
        if (string.IsNullOrEmpty(gradeManagementSearchText))
        {
            courseEnrollments = originalCourseEnrollments.ToList();
        }
        else
        {
            courseEnrollments = originalCourseEnrollments.Where(e =>
                (e.Student?.Name != null && e.Student.Name.Contains(gradeManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                e.StudentSID.ToString().Contains(gradeManagementSearchText) ||
                (e.Student?.Major != null && e.Student.Major.Contains(gradeManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                (e.Student?.Email != null && e.Student.Email.Contains(gradeManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                (e.Student?.Age != null && e.Student.Age.ToString().Contains(gradeManagementSearchText)) ||
                e.Status.Contains(gradeManagementSearchText, StringComparison.OrdinalIgnoreCase) ||
                (e.Grade.HasValue && e.Grade.Value.ToString().Contains(gradeManagementSearchText)) ||
                (e.Semester != null && e.Semester.Contains(gradeManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                e.CreateDate.ToString().Contains(gradeManagementSearchText) ||
                e.UpdateDate.ToString().Contains(gradeManagementSearchText) ||
                (e.CreateUser != null && e.CreateUser.Contains(gradeManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                (e.UpdateUser != null && e.UpdateUser.Contains(gradeManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                (e.Course?.Name != null && e.Course.Name.Contains(gradeManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                e.CourseCID.ToString().Contains(gradeManagementSearchText) ||
                (e.Course?.Credits.ToString().Contains(gradeManagementSearchText) ?? false) ||
                (e.Course?.Description != null && e.Course.Description.Contains(gradeManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                (e.Course?.CourseStatus.ToString().Contains(gradeManagementSearchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (e.Course?.Teacher?.Name != null && e.Course.Teacher.Name.Contains(gradeManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                (e.Course?.Teacher?.TID.ToString().Contains(gradeManagementSearchText) ?? false) ||
                (e.Course?.Teacher?.Major != null && e.Course.Teacher.Major.Contains(gradeManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                (e.Course?.Teacher?.Email != null && e.Course.Teacher.Email.Contains(gradeManagementSearchText, StringComparison.OrdinalIgnoreCase)) ||
                e.Id.ToString().Contains(gradeManagementSearchText) ||
                e.EID.ToString().Contains(gradeManagementSearchText)
            ).ToList();
        }
        StateHasChanged();
    }
    
    private void ClearCourseManagementSearch()
    {
        courseManagementSearchText = "";
        SearchCourseManagement();
    }
    
    private void ClearAvailableCoursesSearch()
    {
        availableCoursesSearchText = "";
        SearchAvailableCourses();
    }
    
    private void ClearGradeManagementSearch()
    {
        gradeManagementSearchText = "";
        SearchGradeManagement();
    }
    
    private void SortCourseManagement(string field, bool asc)
    {
        courseManagementSortField = field;
        courseManagementSortAsc = asc;
        StateHasChanged();
    }
    
    private List<Course> GetSortedCourseManagementData()
    {
        if (teacherCourses == null) return new List<Course>();
        
        switch (courseManagementSortField)
        {
            case "Name":
                return courseManagementSortAsc ? teacherCourses.OrderBy(c => c.Name).ToList() : teacherCourses.OrderByDescending(c => c.Name).ToList();
            case "CID":
                return courseManagementSortAsc ? teacherCourses.OrderBy(c => c.CID).ToList() : teacherCourses.OrderByDescending(c => c.CID).ToList();
            case "Credits":
                return courseManagementSortAsc ? teacherCourses.OrderBy(c => c.Credits).ToList() : teacherCourses.OrderByDescending(c => c.Credits).ToList();
            case "CourseStatus":
                return courseManagementSortAsc ? teacherCourses.OrderBy(c => c.CourseStatus).ToList() : teacherCourses.OrderByDescending(c => c.CourseStatus).ToList();
            default:
                return teacherCourses;
                 }
     }
     
     private void SortAvailableCourses(string field, bool asc)
     {
         availableCoursesSortField = field;
         availableCoursesSortAsc = asc;
         StateHasChanged();
     }
     
     private List<Course> GetSortedAvailableCoursesData()
     {
         if (availableCourses == null) return new List<Course>();
         
         switch (availableCoursesSortField)
         {
             case "Name":
                 return availableCoursesSortAsc ? availableCourses.OrderBy(c => c.Name).ToList() : availableCourses.OrderByDescending(c => c.Name).ToList();
             case "CID":
                 return availableCoursesSortAsc ? availableCourses.OrderBy(c => c.CID).ToList() : availableCourses.OrderByDescending(c => c.CID).ToList();
             case "Credits":
                 return availableCoursesSortAsc ? availableCourses.OrderBy(c => c.Credits).ToList() : availableCourses.OrderByDescending(c => c.Credits).ToList();
             case "CourseStatus":
                 return availableCoursesSortAsc ? availableCourses.OrderBy(c => c.CourseStatus).ToList() : availableCourses.OrderByDescending(c => c.CourseStatus).ToList();
             case "Teacher":
                 return availableCoursesSortAsc ? availableCourses.OrderBy(c => c.Teacher != null ? c.Teacher.Name : "").ToList() : availableCourses.OrderByDescending(c => c.Teacher != null ? c.Teacher.Name : "").ToList();
             default:
                 return availableCourses;
         }
     }
     
     private void SortGradeManagement(string field, bool asc)
     {
         gradeManagementSortField = field;
         gradeManagementSortAsc = asc;
         StateHasChanged();
     }
     
     private List<Enrollment> GetSortedGradeManagementData()
     {
         if (courseEnrollments == null) return new List<Enrollment>();
         
         var activeEnrollments = courseEnrollments.Where(e => e.Status == "Active").ToList();
         
         switch (gradeManagementSortField)
         {
             case "StudentName":
                 return gradeManagementSortAsc ? activeEnrollments.OrderBy(e => e.Student?.Name ?? "").ToList() : activeEnrollments.OrderByDescending(e => e.Student?.Name ?? "").ToList();
             case "StudentSID":
                 return gradeManagementSortAsc ? activeEnrollments.OrderBy(e => e.StudentSID).ToList() : activeEnrollments.OrderByDescending(e => e.StudentSID).ToList();
             case "Grade":
                 return gradeManagementSortAsc ? activeEnrollments.OrderBy(e => e.Grade ?? 0).ToList() : activeEnrollments.OrderByDescending(e => e.Grade ?? 0).ToList();
             default:
                 return activeEnrollments;
         }
     }
 
     private async Task ApplyCourse(Course course)
    {
        try
        {
            if (selectedTeacherTID == 0)
            {
                await JS.InvokeVoidAsync("alert", "请先选择教师");
                return;
            }

            // 检查课程是否为未开课状态
            if (course.CourseStatus != CourseStatus.未开课)
            {
                await JS.InvokeVoidAsync("alert", "只能申请未开课的课程");
                return;
            }

            // 检查课程是否已被其他教师申请
            if (course.TeacherId.HasValue)
            {
                await JS.InvokeVoidAsync("alert", "该课程已被其他教师申请");
                return;
            }

            var teacher = await DB.SMS_Teachers
                .FirstOrDefaultAsync(t => t.TID == selectedTeacherTID);

            if (teacher == null)
            {
                await JS.InvokeVoidAsync("alert", "教师不存在");
                return;
            }

            var existingAssignment = await DB.SMS_Courses
                .FirstOrDefaultAsync(c => c.CID == course.CID && c.TeacherId == teacher.Id);

            if (existingAssignment != null)
            {
                await JS.InvokeVoidAsync("alert", $"您已经申请了课程：{course.Name}");
                return;
            }

            var courseToUpdate = await DB.SMS_Courses.FirstOrDefaultAsync(c => c.Id == course.Id);
            if (courseToUpdate != null)
            {
                courseToUpdate.TeacherId = teacher.Id;
                courseToUpdate.UpdateDate = DateTime.UtcNow;

                await DB.SaveChangesAsync();
                
                await JS.InvokeVoidAsync("alert", $"成功申请课程：{course.Name}");
                
                // 重新加载数据
                await LoadAvailableCourses();
                if (teacherCourses != null)
                {
                    await LoadTeacherAssignedCourses();
                }
                StateHasChanged();
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "课程不存在");
            }
        }
        catch (Exception ex)
        {
            var errorMessage = ex.InnerException?.Message ?? ex.Message;
            await JS.InvokeVoidAsync("alert", $"申请失败: {errorMessage}");
        }
    }
    
    private async Task LoadFinishedCourses()
    {
        if (selectedTeacherTID == 0) return;

        try
        {
            var teacher = await DB.SMS_Teachers
                .FirstOrDefaultAsync(t => t.TID == selectedTeacherTID);

            if (teacher != null)
            {
                finishedCourses = await DB.SMS_Courses
                    .Where(c => c.TeacherId == teacher.Id && c.CourseStatus == CourseStatus.已结束)
                    .OrderBy(c => c.Name)
                    .ToListAsync();
                
                // 保存原始数据用于搜索
                originalFinishedCourses = finishedCourses.ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"加载已结束课程失败: {ex.Message}");
            finishedCourses = new List<Course>();
            originalFinishedCourses = new List<Course>();
        }
    }

    private async Task LoadCourseEnrollments(int courseId)
    {
        try
        {
            // 先获取课程的CID
            var course = await DB.SMS_Courses.FindAsync(courseId);
            if (course == null) return;

            courseEnrollments = await DB.SMS_Enrollments
                .Include(e => e.Student)
                .Include(e => e.Course)
                .Where(e => e.CourseCID == course.CID && e.Status == "Active")
                .OrderBy(e => e.Student!.Name)
                .ToListAsync();

            // 保存原始数据用于搜索
            originalCourseEnrollments = courseEnrollments.ToList();

            // 初始化成绩输入字典
            gradeInputs.Clear();
            foreach (var enrollment in courseEnrollments)
            {
                gradeInputs[enrollment.Id] = (int)(enrollment.Grade ?? 0);
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"加载选课学生失败: {ex.Message}");
            courseEnrollments = new List<Enrollment>();
        }
    }

    private async Task OnCourseSelectionChanged(ChangeEventArgs e)
    {
        selectedCourseForGrade = int.Parse(e.Value?.ToString() ?? "0");
        if (selectedCourseForGrade > 0)
        {
            await LoadCourseEnrollments(selectedCourseForGrade);
            gradeManagementSearchText = ""; // Clear search text for new course
            SearchGradeManagement(); // Re-apply search (which will show all if text is empty)
        }
        else
        {
            courseEnrollments.Clear();
            originalCourseEnrollments = null;
            StateHasChanged();
        }
    }

    private async Task SaveGrade(int enrollmentId)
    {
        try
        {
            if (gradeInputs.ContainsKey(enrollmentId))
            {
                var enrollment = await DB.SMS_Enrollments.FindAsync(enrollmentId);
                if (enrollment != null)
                {
                    enrollment.Grade = gradeInputs[enrollmentId];
                    await DB.SaveChangesAsync();
                    
                    await JS.InvokeVoidAsync("alert", "成绩保存成功");
                    
                    // 重新加载数据以更新显示
                    await LoadCourseEnrollments(selectedCourseForGrade);
                }
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"保存成绩失败: {ex.Message}");
        }
    }

    private string GetGradeColor(int grade)
    {
        if (grade >= 60)
        {
            return "#52c41a"; // 绿色 - 及格
        }
        else
        {
            return "#ff4d4f"; // 红色 - 不及格
        }
    }
    
    private async Task OnTeacherChanged()
    {
        if (selectedTeacherTID > 0)
        {
            await LoadTeacherData();
            StateHasChanged();
        }
        else
        {
            // 重置数据
            teacherCourses = null;
            availableCourses = null;
            finishedCourses = null;
            StateHasChanged();
        }
    }

    // 标签页切换方法
    private void SwitchTab(int tabIndex)
    {
        activeTab = tabIndex;
        StateHasChanged();
    }

    // 教师申请审批相关方法
    private async Task LoadApplications()
    {
        try
        {
            // 加载所有申请记录，包含教师信息
            applications = await DB.SMS_TeacherApplications
                .Include(ta => ta.Teacher)
                .OrderByDescending(ta => ta.CreateDate)
                .ToListAsync();

            // 统计各状态数量
            pendingCount = applications.Count(a => a.Status == ApplicationStatus.Pending);
            approvedCount = applications.Count(a => a.Status == ApplicationStatus.Approved);
            rejectedCount = applications.Count(a => a.Status == ApplicationStatus.Rejected);

            // 应用筛选
            ApplyFilter();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"加载申请数据异常: {ex.Message}");
            await JS.InvokeVoidAsync("alert", "加载申请数据失败: " + ex.Message);
        }
    }

    private void ApplyFilter()
    {
        if (statusFilter == null)
        {
            filteredApplications = applications.ToList();
        }
        else
        {
            filteredApplications = applications.Where(a => (int)a.Status == statusFilter.Value).ToList();
        }
    }

    private void OnStatusFilterChanged(int? value)
    {
        statusFilter = value;
        ApplyFilter();
        StateHasChanged();
    }

    private void OnStatusFilterChangedEvent(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (string.IsNullOrEmpty(value))
        {
            statusFilter = null;
        }
        else if (int.TryParse(value, out int result))
        {
            statusFilter = result;
        }
        ApplyFilter();
        StateHasChanged();
    }

    private void ShowApprovalModal(TeacherApplication application, bool isApproval)
    {
        currentApplication = application;
        isApproving = isApproval;
        approvalModel = new ApprovalModel();
        approvalModalVisible = true;
    }

    private void CloseApprovalModal()
    {
        approvalModalVisible = false;
        currentApplication = null;
        approvalModel = new ApprovalModel();
    }

    private async Task HandleApproval()
    {
        try
        {
            if (currentApplication == null)
            {
                await JS.InvokeVoidAsync("alert", "操作失败，请重新尝试");
                return;
            }

            isSubmitting = true;

            // 更新申请状态
            currentApplication.Status = isApproving ? ApplicationStatus.Approved : ApplicationStatus.Rejected;
            currentApplication.AdminComment = approvalModel.Comment;

            // 如果通过申请，创建课程记录
            if (isApproving)
            {
                // 使用与管理员课程创建相同的逻辑自动生成课程号
                var maxCID = await DB.SMS_Courses.AnyAsync() 
                    ? await DB.SMS_Courses.MaxAsync(c => c.CID) 
                    : 0;
                int nextCourseId = maxCID + 1;
                
                // 更新申请记录中的课程号
                currentApplication.CID = nextCourseId.ToString();
                
                // 获取当前用户（管理员）
                string currentUser = string.Empty;
                try
                {
                    currentUser = await JS.InvokeAsync<string>("localStorage.getItem", "currentUser") ?? string.Empty;
                }
                catch { /* 如果获取失败就使用空字符串 */ }
                
                // 创建新课程，使用与管理员课程创建相同的逻辑
                var newCourse = new Course
                {
                    CID = nextCourseId,
                    Name = currentApplication.Name,
                    Credits = currentApplication.Credits,
                    Description = currentApplication.Description,
                    TeacherId = currentApplication.TeacherId,
                    CourseStatus = CourseStatus.未开课,
                    CreateUser = !string.IsNullOrEmpty(currentUser) ? currentUser : "System",
                    UpdateUser = !string.IsNullOrEmpty(currentUser) ? currentUser : "System",
                    CreateDate = DateTime.UtcNow,
                    UpdateDate = DateTime.UtcNow
                };

                DB.SMS_Courses.Add(newCourse);
            }

            await DB.SaveChangesAsync();

            string message = isApproving ? "申请已通过，课程已创建/分配教师" : "申请已拒绝";
            await JS.InvokeVoidAsync("alert", message);
            
            CloseApprovalModal();
            await LoadApplications();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"审批操作异常: {ex.Message}");
            await JS.InvokeVoidAsync("alert", "审批操作失败: " + ex.Message);
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
