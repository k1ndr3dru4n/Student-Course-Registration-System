@page "/student-pages/student-grades"
@using SMS.Models
@using Microsoft.EntityFrameworkCore
@using AntDesign
@inject SMS.CimContext DB
@inject IJSRuntime JS
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>成绩查询 - 学生端</PageTitle>

<div style="padding: 24px; max-width: 1000px; margin: auto;">
    <h2 style="margin-bottom: 8px; color: #1f2937; font-weight: 600;">成绩查询</h2>
    <p style="color: #6b7280; margin-bottom: 24px;">请选择学生并查询成绩</p>

    @if (currentStudent == null)
    {
        <div style="text-align:center; color:#888; padding:32px;">正在加载学生信息...</div>
    }
    else
    {
        <div style="margin-bottom: 24px; padding: 16px; border: 1px solid #f0f0f0; border-radius: 6px;">
            <h3>学生信息</h3>
            <div style="display: flex; gap: 16px; align-items: center;">
                <span style="font-size: 16px; font-weight: 500;">@currentStudent.Name (学号: @currentStudent.SID)</span>
            </div>
        </div>

        @if (selectedStudentSID > 0)
        {
            <div style="margin-bottom: 24px;">
                <input type="text" @bind="gradeSearchText" placeholder="搜索课程名称、课程号、教师等..." style="padding: 6px 12px; border-radius: 4px; border: 1px solid #d1d5db; width: 220px; margin-right: 8px;" />
                <button @onclick="SearchGrades" style="padding: 6px 16px; background: #2563eb; color: white; border: none; border-radius: 4px;">搜索</button>
                <button @onclick="ClearGradeSearch" style="padding: 6px 16px; background: #f3f4f6; color: #666; border: 1px solid #d1d5db; border-radius: 4px; margin-left: 4px;">清除</button>
            </div>
            @if (studentEnrollments == null)
            {
                <div style="text-align: center; color: #666; padding: 32px;">正在加载成绩数据...</div>
            }
            else if (!studentEnrollments.Any())
            {
                <div style="text-align: center; color: #666; padding: 32px;">暂无成绩记录</div>
            }
            else
            {
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f3f4f6;">
                            <th style="padding: 10px; border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center;">
                                    <span>课程名称</span>
                                    <span style="margin-left: 8px; flex-direction: column;">
                                        <span style="cursor: pointer; color: @(sortField=="Name"&&sortAsc?"#2563eb":"#ccc");" @onclick='() => SortGrades("Name", true)'>▲</span>
                                        <span style="cursor: pointer; color: @(sortField=="Name"&&!sortAsc?"#2563eb":"#ccc");" @onclick='() => SortGrades("Name", false)'>▼</span>
                                    </span>
                                </div>
                            </th>
                            <th style="padding: 10px; border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; justify-content: center;">
                                    <span>课程号</span>
                                    <span style="margin-left: 8px; flex-direction: column;">
                                        <span style="cursor: pointer; color: @(sortField=="CID"&&sortAsc?"#2563eb":"#ccc");" @onclick='() => SortGrades("CID", true)'>▲</span>
                                        <span style="cursor: pointer; color: @(sortField=="CID"&&!sortAsc?"#2563eb":"#ccc");" @onclick='() => SortGrades("CID", false)'>▼</span>
                                    </span>
                                </div>
                            </th>
                            <th style="padding: 10px; border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; justify-content: center;">
                                    <span>学分</span>
                                    <span style="margin-left: 8px; flex-direction: column;">
                                        <span style="cursor: pointer; color: @(sortField=="Credits"&&sortAsc?"#2563eb":"#ccc");" @onclick='() => SortGrades("Credits", true)'>▲</span>
                                        <span style="cursor: pointer; color: @(sortField=="Credits"&&!sortAsc?"#2563eb":"#ccc");" @onclick='() => SortGrades("Credits", false)'>▼</span>
                                    </span>
                                </div>
                            </th>
                            <th style="padding: 10px; border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; justify-content: center;">
                                    <span>授课教师</span>
                                    <span style="margin-left: 8px; flex-direction: column;">
                                        <span style="cursor: pointer; color: @(sortField=="Teacher"&&sortAsc?"#2563eb":"#ccc");" @onclick='() => SortGrades("Teacher", true)'>▲</span>
                                        <span style="cursor: pointer; color: @(sortField=="Teacher"&&!sortAsc?"#2563eb":"#ccc");" @onclick='() => SortGrades("Teacher", false)'>▼</span>
                                    </span>
                                </div>
                            </th>
                            <th style="padding: 10px; border: 1px solid #e5e7eb;">
                                <div style="display: flex; align-items: center; justify-content: center;">
                                    <span>成绩</span>
                                    <span style="margin-left: 8px; flex-direction: column;">
                                        <span style="cursor: pointer; color: @(sortField=="Grade"&&sortAsc?"#2563eb":"#ccc");" @onclick='() => SortGrades("Grade", true)'>▲</span>
                                        <span style="cursor: pointer; color: @(sortField=="Grade"&&!sortAsc?"#2563eb":"#ccc");" @onclick='() => SortGrades("Grade", false)'>▼</span>
                                    </span>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var enrollment in GetSortedGrades())
                        {
                            <tr>
                                <td style="padding: 10px; border: 1px solid #e5e7eb;">@enrollment.Course!.Name</td>
                                <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">@enrollment.CourseCID</td>
                                <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">@enrollment.Course!.Credits</td>
                                <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">@(enrollment.Course?.Teacher?.Name ?? "未知")</td>
                                <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: center;">
                                    <span style="color: @(enrollment.Grade >= 60 ? "#22c55e" : "#ef4444"); font-weight: 500;">@(enrollment.Grade.HasValue ? enrollment.Grade.Value.ToString("F1") : "未录入")</span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        }
    }
</div>

@code {
    private List<Student> students = new();
    private int selectedStudentSID = 0;
    private Student? currentStudent;
    private string currentUser = string.Empty;
    private List<Enrollment> studentEnrollments = new();
    private string gradeSearchText = string.Empty;
    private string sortField = "Name";
    private bool sortAsc = true;

    protected override void OnInitialized()
    {
        // 不做JS调用，相关逻辑移到OnAfterRenderAsync
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            currentUser = await JS.InvokeAsync<string>("localStorage.getItem", "currentUser");
            if (!string.IsNullOrEmpty(currentUser))
            {
                currentStudent = await DB.SMS_Students.FirstOrDefaultAsync(s => s.Username != null && s.Username == currentUser);
                if (currentStudent != null)
                {
                    selectedStudentSID = currentStudent.SID;
                }
            }
            students = currentStudent != null ? new List<Student> { currentStudent } : new List<Student>();
            await LoadStudentGrades();
            StateHasChanged();
        }
    }

    // 学生端只允许查询自己，无需切换学生

    private async Task LoadStudentGrades()
    {
        studentEnrollments = (await DB.SMS_Enrollments.Include(e => e.Course).ThenInclude(c => c.Teacher)
            .Where(e => e != null && e.StudentSID == selectedStudentSID && e.Course != null && e.Course.Teacher != null)
            .ToListAsync()) ?? new List<Enrollment>();
        StateHasChanged();
    }

    private async Task SearchGrades()
    {
        await LoadStudentGrades();
        if (!string.IsNullOrWhiteSpace(gradeSearchText))
        {
            studentEnrollments = studentEnrollments
                .Where(e => e.Course != null && (
                    (e.Course.Name != null && e.Course.Name.Contains(gradeSearchText)) ||
                    (e.Course.CID.ToString().Contains(gradeSearchText)) ||
                    (e.Course.Teacher != null && e.Course.Teacher.Name != null && e.Course.Teacher.Name.Contains(gradeSearchText))
                ))
                .ToList();
        }
        StateHasChanged();
    }

    private async Task ClearGradeSearch()
    {
        gradeSearchText = string.Empty;
        await SearchGrades();
    }

    private IEnumerable<Enrollment> GetFilteredGradeViewData()
    {
        return studentEnrollments;
    }

    private void SortGrades(string field, bool asc)
    {
        sortField = field;
        sortAsc = asc;
        StateHasChanged();
    }

    private IEnumerable<Enrollment> GetSortedGrades()
    {
        IEnumerable<Enrollment> query = GetFilteredGradeViewData();
        switch (sortField)
        {
            case "Name":
                query = sortAsc ? query.OrderBy(e => e.Course?.Name) : query.OrderByDescending(e => e.Course?.Name);
                break;
            case "CID":
                query = sortAsc ? query.OrderBy(e => e.CourseCID) : query.OrderByDescending(e => e.CourseCID);
                break;
            case "Credits":
                query = sortAsc ? query.OrderBy(e => e.Course?.Credits) : query.OrderByDescending(e => e.Course?.Credits);
                break;
            case "Teacher":
                query = sortAsc ? query.OrderBy(e => e.Course?.Teacher?.Name) : query.OrderByDescending(e => e.Course?.Teacher?.Name);
                break;
            case "Grade":
                query = sortAsc ? query.OrderBy(e => e.Grade ?? -1) : query.OrderByDescending(e => e.Grade ?? -1);
                break;
        }
        return query;
    }
}