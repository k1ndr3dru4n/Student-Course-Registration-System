@page "/forgot-password"
@layout SMS.Components.Layout.AuthLayout
@using SMS.Components.Layout
@using SMS.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@inject NavigationManager NavigationManager
@inject IDbContextFactory<CimContext> DbContextFactory
@rendermode InteractiveServer

<AntDesign.Row style="margin-top: 80px; justify-content: center;">
    <AntDesign.Col Span="8">
        <AntDesign.Card>
            <TitleTemplate>
                <h3 style="text-align: center; margin: 0;">重置密码</h3>
            </TitleTemplate>
            <Body>
                @if (!string.IsNullOrEmpty(message))
                {
                    <div style="background: #fff2f0; border: 1px solid #ffccc7; color: #cf1322; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
                        @message
                    </div>
                }

                <EditForm Model="@resetModel" OnValidSubmit="HandlePasswordReset" FormName="resetPasswordForm">
                    <DataAnnotationsValidator />
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">用户名</label>
                        <AntDesign.Input @bind-Value="resetModel.Username" Placeholder="请输入用户名" Style="width: 100%;" AllowClear="true" />
                        <ValidationMessage For="@(() => resetModel.Username)" />
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">新密码</label>
                        <AntDesign.InputPassword @bind-Value="resetModel.NewPassword" Placeholder="请输入新密码" Style="width: 100%;" />
                        <ValidationMessage For="@(() => resetModel.NewPassword)" />
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">确认新密码</label>
                        <AntDesign.InputPassword @bind-Value="resetModel.ConfirmPassword" Placeholder="请再次输入新密码" Style="width: 100%;" />
                        <ValidationMessage For="@(() => resetModel.ConfirmPassword)" />
                    </div>
                    <AntDesign.Button Type="@AntDesign.ButtonType.Primary" HtmlType="submit" Block="true" Size="@AntDesign.ButtonSize.Large" Loading="@isSubmitting" Style="width: 100%; height: 44px; font-size: 16px;">
                        @if (isSubmitting)
                        {
                            <span>重置中...</span>
                        }
                        else
                        {
                            <span>重置密码</span>
                        }
                    </AntDesign.Button>
                </EditForm>
                        
                <div style="text-align: center; margin-top: 16px;">
                    <span>记起密码了？ <a href="/login">返回登录</a></span>
                </div>
            </Body>
        </AntDesign.Card>
    </AntDesign.Col>
</AntDesign.Row>

@code {
    private ResetModel resetModel = new();
    private string message = string.Empty;
    private bool isSuccess;
    private bool isSubmitting;

    private class ResetModel
    {
        [Required(ErrorMessage = "请输入用户名")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "请输入新密码")]
        [MinLength(6, ErrorMessage = "密码长度至少6位")]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "请确认新密码")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    private async Task HandlePasswordReset()
    {
        if (isSubmitting) return;

        try
        {
            isSubmitting = true;
            message = string.Empty; // 清除之前的消息
            StateHasChanged(); // 立即更新UI状态

            // 验证密码确认
            if (resetModel.NewPassword != resetModel.ConfirmPassword)
            {
                message = "两次输入的密码不一致";
                isSuccess = false;
                StateHasChanged();
                return;
            }

            using var context = await DbContextFactory.CreateDbContextAsync();
            var user = await context.SMS_Users.FirstOrDefaultAsync(u => u.Username == resetModel.Username);

            if (user == null)
            {
                message = "用户不存在";
                isSuccess = false;
                StateHasChanged();
                return;
            }

            // 更新用户密码
            user.Password = resetModel.NewPassword;
            await context.SaveChangesAsync();

            message = "密码重置成功，即将跳转到登录页面";
            isSuccess = true;
            StateHasChanged();

            // 等待一秒后跳转到登录页面
            await Task.Delay(1500);
            NavigationManager.NavigateTo("/login", forceLoad: true);
        }
        catch (Exception ex)
        {
            message = $"密码重置失败: {ex.Message}";
            isSuccess = false;
            Console.WriteLine($"密码重置异常: {ex.Message}");
            StateHasChanged();
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }
}
