@page "/forgot-password"
@layout SMS.Components.Layout.AuthLayout
@using SMS.Components.Layout
@using SMS.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@inject NavigationManager NavigationManager
@inject IDbContextFactory<CimContext> DbContextFactory
@rendermode InteractiveServer

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">重置密码</h3>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(message))
                    {
                        <div class="alert @(isSuccess ? "alert-success" : "alert-danger")">
                            @message
                        </div>
                    }

                    <EditForm Model="@resetModel" OnValidSubmit="HandlePasswordReset" FormName="resetPasswordForm">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="form-group mb-3">
                            <label for="username">用户名</label>
                            <InputText id="username" class="form-control" @bind-Value="resetModel.Username" />
                            <ValidationMessage For="@(() => resetModel.Username)" />
                        </div>

                        <div class="form-group mb-3">
                            <label for="newPassword">新密码</label>
                            <InputText type="password" id="newPassword" class="form-control" @bind-Value="resetModel.NewPassword" />
                            <ValidationMessage For="@(() => resetModel.NewPassword)" />
                        </div>

                        <div class="form-group mb-3">
                            <label for="confirmPassword">确认新密码</label>
                            <InputText type="password" id="confirmPassword" class="form-control" @bind-Value="resetModel.ConfirmPassword" />
                            <ValidationMessage For="@(() => resetModel.ConfirmPassword)" />
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mb-3" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span class="ms-2">重置中...</span>
                            }
                            else
                            {
                                <span>重置密码</span>
                            }
                        </button>
                        
                        <div class="text-center">
                            <p>记起密码了？ <a href="/login">返回登录</a></p>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ResetModel resetModel = new();
    private string message = string.Empty;
    private bool isSuccess;
    private bool isSubmitting;

    private class ResetModel
    {
        [Required(ErrorMessage = "请输入用户名")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "请输入新密码")]
        [MinLength(6, ErrorMessage = "密码长度至少6位")]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "请确认新密码")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    private async Task HandlePasswordReset()
    {
        if (isSubmitting) return;

        try
        {
            isSubmitting = true;

            // 验证密码确认
            if (resetModel.NewPassword != resetModel.ConfirmPassword)
            {
                message = "两次输入的密码不一致";
                isSuccess = false;
                return;
            }

            using var context = await DbContextFactory.CreateDbContextAsync();
            var user = await context.Users.FirstOrDefaultAsync(u => u.Username == resetModel.Username);

            if (user == null)
            {
                message = "用户不存在";
                isSuccess = false;
                return;
            }

            // 更新用户密码
            user.Password = BCrypt.Net.BCrypt.HashPassword(resetModel.NewPassword);
            await context.SaveChangesAsync();

            message = "密码重置成功，即将跳转到登录页面";
            isSuccess = true;

            // 等待一秒后跳转到登录页面
            await Task.Delay(1500);
            NavigationManager.NavigateTo("/login", forceLoad: true);
        }
        catch (Exception ex)
        {
            message = $"密码重置失败: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }
}
