@page "/forgot-password"
@using SMS.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@inject NavigationManager NavigationManager
@inject IDbContextFactory<CimContext> DbContextFactory

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">重置密码</h3>
                </div>
                <div class="card-body">
                    <EditForm Model="@resetModel" OnValidSubmit="HandlePasswordReset" FormName="resetPasswordForm">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="form-group mb-3">
                            <label for="email">电子邮箱</label>
                            <InputText id="email" class="form-control" @bind-Value="resetModel.Email" />
                            <ValidationMessage For="@(() => resetModel.Email)" />
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mb-3">发送重置链接</button>
                        
                        <div class="text-center">
                            <p>记起密码了？ <a href="/login">返回登录</a></p>
                        </div>
                    </EditForm>

                    @if (!string.IsNullOrEmpty(message))
                    {
                        <div class="alert @(isSuccess ? "alert-success" : "alert-danger") mt-3">
                            @message
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ResetModel resetModel = new();
    private string message = string.Empty;
    private bool isSuccess;

    private class ResetModel
    {
        [Required(ErrorMessage = "请输入邮箱")]
        [EmailAddress(ErrorMessage = "请输入有效的邮箱地址")]
        public string Email { get; set; } = string.Empty;
    }

    private async Task HandlePasswordReset()
    {
        using var context = await DbContextFactory.CreateDbContextAsync();
        var user = await context.Users.FirstOrDefaultAsync(u => u.Email == resetModel.Email);

        if (user == null)
        {
            message = "未找到该邮箱对应的用户";
            isSuccess = false;
            return;
        }

        // TODO: 实现发送重置密码邮件的逻辑
        // 这里应该生成一个重置token，保存到数据库，并发送重置链接到用户邮箱
        // 为了演示，我们直接显示一个成功消息
        
        message = "重置密码链接已发送到您的邮箱，请查收";
        isSuccess = true;
    }
}
