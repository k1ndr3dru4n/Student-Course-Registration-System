@page "/forgot-password"
@layout SMS.Components.Layout.AuthLayout
@using SMS.Components.Layout
@using SMS.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@inject NavigationManager NavigationManager
@inject IDbContextFactory<CimContext> DbContextFactory
@rendermode InteractiveServer

<style>
    body, html {
        overflow: hidden !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
    }
</style>

<div style="height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; padding: 20px; overflow: hidden;">
    <div style="width: 100%; max-width: 400px;">
        <AntDesign.Card style="border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); border: none;">
            <Body>
                <div style="padding: 40px;">
                    <!-- 标题区域 -->
                    <div style="text-align: center; margin-bottom: 32px;">
                        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                            <AntDesign.Icon Type="lock" style="font-size: 28px; color: white;" />
                        </div>
                        <h2 style="margin: 0; color: #1f2937; font-weight: 600; font-size: 24px;">重置密码</h2>
                        <p style="margin: 8px 0 0; color: #6b7280; font-size: 14px;">输入新密码重置您的账户</p>
                    </div>
                @if (!string.IsNullOrEmpty(message))
                {
                    <div style="background: #fff2f0; border: 1px solid #ffccc7; color: #cf1322; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
                        @message
                    </div>
                }

                <EditForm Model="@resetModel" OnValidSubmit="HandlePasswordReset" FormName="resetPasswordForm">
                    <DataAnnotationsValidator />
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">用户名</label>
                        <AntDesign.Input @bind-Value="resetModel.Username" Placeholder="请输入用户名" Style="width: 100%;" AllowClear="true" />
                        <ValidationMessage For="@(() => resetModel.Username)" />
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">新密码</label>
                        <AntDesign.InputPassword @bind-Value="resetModel.NewPassword" Placeholder="请输入新密码" Style="width: 100%;" />
                        <ValidationMessage For="@(() => resetModel.NewPassword)" />
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">确认新密码</label>
                        <AntDesign.InputPassword @bind-Value="resetModel.ConfirmPassword" Placeholder="请再次输入新密码" Style="width: 100%;" />
                        <ValidationMessage For="@(() => resetModel.ConfirmPassword)" />
                    </div>
                    <AntDesign.Button Type="@AntDesign.ButtonType.Primary" HtmlType="submit" Block="true" Size="@AntDesign.ButtonSize.Large" Loading="@isSubmitting" Style="width: 100%; height: 44px; font-size: 16px;">
                        @if (isSubmitting)
                        {
                            <span>重置中...</span>
                        }
                        else
                        {
                            <span>重置密码</span>
                        }
                    </AntDesign.Button>
                </EditForm>
                        
                
                <!-- 底部链接 -->
                <div style="text-align: center; margin-top: 24px;">
                    <span style="color: #666;">记起密码了？</span>
                    <a href="/login" style="color: #1890ff; text-decoration: none; margin-left: 4px;">返回登录</a>
                </div>
                </div>
            </Body>
        </AntDesign.Card>
    </div>
</div>

@code {
    private ResetModel resetModel = new();
    private string message = string.Empty;
    private bool isSubmitting;

    private class ResetModel
    {
        [Required(ErrorMessage = "请输入用户名")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "请输入新密码")]
        [MinLength(6, ErrorMessage = "密码长度至少6位")]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "请确认新密码")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    private async Task HandlePasswordReset()
    {
        if (isSubmitting) return;

        try
        {
            isSubmitting = true;
            message = string.Empty; // 清除之前的消息
            StateHasChanged(); // 立即更新UI状态

            // 验证密码确认
            if (resetModel.NewPassword != resetModel.ConfirmPassword)
            {
                message = "两次输入的密码不一致";
                StateHasChanged();
                return;
            }

            using var context = await DbContextFactory.CreateDbContextAsync();
            var user = await context.SMS_Users.FirstOrDefaultAsync(u => u.Username == resetModel.Username);

            if (user == null)
            {
                message = "用户不存在";
                StateHasChanged();
                return;
            }

            // 更新用户密码
            user.Password = resetModel.NewPassword;
            await context.SaveChangesAsync();

            message = "密码重置成功，即将跳转到登录页面";
            StateHasChanged();

            // 等待一秒后跳转到登录页面
            await Task.Delay(1500);
            NavigationManager.NavigateTo("/login", forceLoad: true);
        }
        catch (Exception ex)
        {
            message = $"密码重置失败: {ex.Message}";
            Console.WriteLine($"密码重置异常: {ex.Message}");
            StateHasChanged();
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }
}
